%%
% Copyright (c) 2018, Pascal Wagler;  
% Copyright (c) 2014--2018, John MacFarlane
% 
% All rights reserved.
% 
% Redistribution and use in source and binary forms, with or without 
% modification, are permitted provided that the following conditions 
% are met:
% 
% - Redistributions of source code must retain the above copyright 
% notice, this list of conditions and the following disclaimer.
% 
% - Redistributions in binary form must reproduce the above copyright 
% notice, this list of conditions and the following disclaimer in the 
% documentation and/or other materials provided with the distribution.
% 
% - Neither the name of John MacFarlane nor the names of other 
% contributors may be used to endorse or promote products derived 
% from this software without specific prior written permission.
% 
% THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS 
% "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT 
% LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS 
% FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE 
% COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, 
% INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING,
% BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; 
% LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER 
% CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT 
% LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN 
% ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE 
% POSSIBILITY OF SUCH DAMAGE.
%%

%%
% For usage information and examples visit the GitHub page of this template:
% https://github.com/Wandmalfarbe/pandoc-latex-template
%%

\PassOptionsToPackage{unicode=true}{hyperref} % options for packages loaded elsewhere
\PassOptionsToPackage{hyphens}{url}
\PassOptionsToPackage{dvipsnames,svgnames*,table}{xcolor}
%
\documentclass[a4paperpaper,,tablecaptionabove]{scrartcl}
\usepackage{lmodern}
\usepackage{setspace}
\setstretch{1.2}
\usepackage{amssymb,amsmath}
\usepackage{ifxetex,ifluatex}
\usepackage{fixltx2e} % provides \textsubscript
\ifnum 0\ifxetex 1\fi\ifluatex 1\fi=0 % if pdftex
  \usepackage[T1]{fontenc}
  \usepackage[utf8]{inputenc}
  \usepackage{textcomp} % provides euro and other symbols
\else % if luatex or xelatex
  \usepackage{unicode-math}
  \defaultfontfeatures{Ligatures=TeX,Scale=MatchLowercase}
\fi
% use upquote if available, for straight quotes in verbatim environments
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
% use microtype if available
\IfFileExists{microtype.sty}{%
\usepackage[]{microtype}
\UseMicrotypeSet[protrusion]{basicmath} % disable protrusion for tt fonts
}{}
\IfFileExists{parskip.sty}{%
\usepackage{parskip}
}{% else
\setlength{\parindent}{0pt}
\setlength{\parskip}{6pt plus 2pt minus 1pt}
}
\usepackage{xcolor}
\definecolor{default-linkcolor}{HTML}{A50000}
\definecolor{default-filecolor}{HTML}{A50000}
\definecolor{default-citecolor}{HTML}{4077C0}
\definecolor{default-urlcolor}{HTML}{4077C0}
\usepackage{hyperref}
\hypersetup{
            pdftitle={PC\_geomorph\_roughness},
            pdfauthor={Bodo Bookhagen (bodo.bookhagen@uni-potsdam.de)},
            pdfsubject={Geomorphology},
            pdfkeywords={Point Cloud, Classification, lidar, SfM, geomorphology},
            colorlinks=true,
            linkcolor=default-linkcolor,
            filecolor=default-filecolor,
            citecolor=default-citecolor,
            urlcolor=blue,
            breaklinks=true}
\urlstyle{same}  % don't use monospace font for urls
\usepackage[margin=2.5cm,includehead=true,includefoot=true,centering]{geometry}
\usepackage[export]{adjustbox}
\usepackage{graphicx}
\usepackage{listings}
\newcommand{\passthrough}[1]{#1}
\usepackage{graphicx,grffile}
\makeatletter
\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
\def\maxheight{\ifdim\Gin@nat@height>\textheight\textheight\else\Gin@nat@height\fi}
\makeatother
% Scale images if necessary, so that they will not overflow the page
% margins by default, and it is still possible to overwrite the defaults
% using explicit options in \includegraphics[width, height, ...]{}
\setkeys{Gin}{width=\maxwidth,height=\maxheight,keepaspectratio}
\setlength{\emergencystretch}{3em}  % prevent overfull lines
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}
\setcounter{secnumdepth}{5}
% Redefines (sub)paragraphs to behave more like sections
\ifx\paragraph\undefined\else
\let\oldparagraph\paragraph
\renewcommand{\paragraph}[1]{\oldparagraph{#1}\mbox{}}
\fi
\ifx\subparagraph\undefined\else
\let\oldsubparagraph\subparagraph
\renewcommand{\subparagraph}[1]{\oldsubparagraph{#1}\mbox{}}
\fi

% Make use of float-package and set default placement for figures to H
\usepackage{float}
\floatplacement{figure}{H}

% LATEX HEADER SNIPPET
% pass this file to PANDOC using its -H option:
% pandoc --listings -H auto_linebreak_listings.tex PC_geomorph_roughness_manual.md -o PC_geomorph_roughness_manual.pdf

\lstset{
    basicstyle=\ttfamily,
    keywordstyle=\color[rgb]{0.13,0.29,0.53}\bfseries,
    stringstyle=\color[rgb]{0.31,0.60,0.02},
    commentstyle=\color[rgb]{0.56,0.35,0.01}\itshape,
    numberstyle=\footnotesize,
    stepnumber=1,
    numbersep=5pt,
    backgroundcolor=\color[RGB]{248,248,248},
    showspaces=false,
    showstringspaces=false,
    showtabs=false,
    tabsize=2,
    captionpos=b,
    breaklines=true,
    breakatwhitespace=true,
%    breakautoindent=true,
%    escapeinside={\%*}{*)},
    linewidth=\textwidth,
    basewidth=0.5em,
    breaklines=true,
%    prebreak={ \textbackslash},
    prebreak={\space\textbackslash}
%    postbreak=\mbox{\textcolor{red}{$\hookrightarrow$}\space}
}

\title{\emph{PC\_geomorph\_roughness}}
\providecommand{\subtitle}[1]{}
\subtitle{Pre-process and classify lidar or SfM point-cloud data for processing
with \emph{PC\_geomorph\_roughness}}
\author{Bodo Bookhagen (\url{bodo.bookhagen@uni-potsdam.de})}
\date{December 2018}





%%
%% added
%%

%
% No language specified? take American English.
%

\ifnum 0\ifxetex 1\fi\ifluatex 1\fi=0 % if pdftex
  \usepackage[shorthands=off,main=english]{babel}
\else
    % See issue https://github.com/reutenauer/polyglossia/issues/127
  \renewcommand*\familydefault{\sfdefault}
    % load polyglossia as late as possible as it *could* call bidi if RTL lang (e.g. Hebrew or Arabic)
  \usepackage{polyglossia}
  \setmainlanguage[]{english}
\fi


%
% colors
%
\usepackage[]{xcolor}

%
% listing colors
%
\definecolor{listing-background}{HTML}{F7F7F7}
\definecolor{listing-rule}{HTML}{B3B2B3}
\definecolor{listing-numbers}{HTML}{B3B2B3}
\definecolor{listing-text-color}{HTML}{000000}
\definecolor{listing-keyword}{HTML}{435489}
\definecolor{listing-identifier}{HTML}{435489}
\definecolor{listing-string}{HTML}{00999A}
\definecolor{listing-comment}{HTML}{8E8E8E}
\definecolor{listing-javadoc-comment}{HTML}{006CA9}

%\definecolor{listing-background}{rgb}{0.97,0.97,0.97}
%\definecolor{listing-rule}{HTML}{B3B2B3}
%\definecolor{listing-numbers}{HTML}{B3B2B3}
%\definecolor{listing-text-color}{HTML}{000000}
%\definecolor{listing-keyword}{HTML}{D8006B}
%\definecolor{listing-identifier}{HTML}{000000}
%\definecolor{listing-string}{HTML}{006CA9}
%\definecolor{listing-comment}{rgb}{0.25,0.5,0.35}
%\definecolor{listing-javadoc-comment}{HTML}{006CA9}

%
% for the background color of the title page
%
\usepackage{pagecolor}
\usepackage{afterpage}

%
% TOC depth and 
% section numbering depth
%
\setcounter{tocdepth}{3}
\setcounter{secnumdepth}{3}

%
% break urls
%
\PassOptionsToPackage{hyphens}{url}

%
% When using babel or polyglossia with biblatex, loading csquotes is recommended 
% to ensure that quoted texts are typeset according to the rules of your main language.
%
\usepackage{csquotes}

%
% captions
%
\definecolor{caption-color}{HTML}{777777}
\usepackage[font={stretch=1.2}, textfont={color=caption-color}, position=top, skip=4mm, labelfont=bf, singlelinecheck=false, justification=raggedright]{caption}
\setcapindent{0em}
\captionsetup[longtable]{position=above}

%
% blockquote
%
\definecolor{blockquote-border}{RGB}{221,221,221}
\definecolor{blockquote-text}{RGB}{119,119,119}
\usepackage{mdframed}
\newmdenv[rightline=false,bottomline=false,topline=false,linewidth=3pt,linecolor=blockquote-border,skipabove=\parskip]{customblockquote}
\renewenvironment{quote}{\begin{customblockquote}\list{}{\rightmargin=0em\leftmargin=0em}%
\item\relax\color{blockquote-text}\ignorespaces}{\unskip\unskip\endlist\end{customblockquote}}

%
% Source Sans Pro as the de­fault font fam­ily
% Source Code Pro for monospace text
%
% 'default' option sets the default 
% font family to Source Sans Pro, not \sfdefault.
%
\usepackage[default]{sourcesanspro}
\usepackage{sourcecodepro}

%
% heading color
%
\definecolor{heading-color}{RGB}{40,40,40}
\addtokomafont{section}{\color{heading-color}}
% When using the classes report, scrreprt, book, 
% scrbook or memoir, uncomment the following line.
%\addtokomafont{chapter}{\color{heading-color}}

%
% variables for title and author
%
\usepackage{titling}
\title{\emph{PC\_geomorph\_roughness}}
\author{Bodo Bookhagen (\url{bodo.bookhagen@uni-potsdam.de})}

%
% tables
%

%
% remove paragraph indention
%
\setlength{\parindent}{0pt}
\setlength{\parskip}{6pt plus 2pt minus 1pt}
\setlength{\emergencystretch}{3em}  % prevent overfull lines

%
%
% Listings
%
%

\lstdefinestyle{eisvogel_listing_style}{
  language         = java,
  xleftmargin      = 0.6em,
  framexleftmargin = 0.4em,
  backgroundcolor  = \color{listing-background},
  basicstyle       = \color{listing-text-color}\small\ttfamily{}\linespread{1.15}, % print whole listing small
  breaklines       = true,
  frame            = single,
  framesep         = 0.6mm,
  rulecolor        = \color{listing-rule},
  frameround       = ffff,
  tabsize          = 4,
  numberstyle      = \color{listing-numbers},
  aboveskip        = 1.0em,
  belowcaptionskip = 1.0em,
  keywordstyle     = \color{listing-keyword}\bfseries,
  classoffset      = 0,
  sensitive        = true,
  identifierstyle  = \color{listing-identifier},
  commentstyle     = \color{listing-comment},
  morecomment      = [s][\color{listing-javadoc-comment}]{/**}{*/},
  stringstyle      = \color{listing-string},
  showstringspaces = false,
  escapeinside     = {/*@}{@*/}, % Allow LaTeX inside these special comments
  literate         =
  {á}{{\'a}}1 {é}{{\'e}}1 {í}{{\'i}}1 {ó}{{\'o}}1 {ú}{{\'u}}1
  {Á}{{\'A}}1 {É}{{\'E}}1 {Í}{{\'I}}1 {Ó}{{\'O}}1 {Ú}{{\'U}}1
  {à}{{\`a}}1 {è}{{\'e}}1 {ì}{{\`i}}1 {ò}{{\`o}}1 {ù}{{\`u}}1
  {À}{{\`A}}1 {È}{{\'E}}1 {Ì}{{\`I}}1 {Ò}{{\`O}}1 {Ù}{{\`U}}1
  {ä}{{\"a}}1 {ë}{{\"e}}1 {ï}{{\"i}}1 {ö}{{\"o}}1 {ü}{{\"u}}1
  {Ä}{{\"A}}1 {Ë}{{\"E}}1 {Ï}{{\"I}}1 {Ö}{{\"O}}1 {Ü}{{\"U}}1
  {â}{{\^a}}1 {ê}{{\^e}}1 {î}{{\^i}}1 {ô}{{\^o}}1 {û}{{\^u}}1
  {Â}{{\^A}}1 {Ê}{{\^E}}1 {Î}{{\^I}}1 {Ô}{{\^O}}1 {Û}{{\^U}}1
  {œ}{{\oe}}1 {Œ}{{\OE}}1 {æ}{{\ae}}1 {Æ}{{\AE}}1 {ß}{{\ss}}1
  {ç}{{\c c}}1 {Ç}{{\c C}}1 {ø}{{\o}}1 {å}{{\r a}}1 {Å}{{\r A}}1
  {€}{{\EUR}}1 {£}{{\pounds}}1 {«}{{\guillemotleft}}1
  {»}{{\guillemotright}}1 {ñ}{{\~n}}1 {Ñ}{{\~N}}1 {¿}{{?`}}1
  {…}{{\ldots}}1 {≥}{{>=}}1 {≤}{{<=}}1 {„}{{\glqq}}1 {“}{{\grqq}}1
  {”}{{''}}1
}
\lstset{style=eisvogel_listing_style}

\lstdefinelanguage{XML}{
  morestring      = [b]",
  moredelim       = [s][\bfseries\color{listing-keyword}]{<}{\ },
  moredelim       = [s][\bfseries\color{listing-keyword}]{</}{>},
  moredelim       = [l][\bfseries\color{listing-keyword}]{/>},
  moredelim       = [l][\bfseries\color{listing-keyword}]{>},
  morecomment     = [s]{<?}{?>},
  morecomment     = [s]{<!--}{-->},
  commentstyle    = \color{listing-comment},
  stringstyle     = \color{listing-string},
  identifierstyle = \color{listing-identifier}
}

%
% header and footer
%

%%
%% end added
%%

\begin{document}

%%
%% begin titlepage
%%

\begin{titlepage}
\newgeometry{left=6cm}
\newcommand{\colorRule}[3][black]{\textcolor[HTML]{#1}{\rule{#2}{#3}}}
\begin{flushleft}
\noindent
\\[-1em]
\color[HTML]{5F5F5F}
\makebox[0pt][l]{\colorRule[435488]{1.3\textwidth}{2pt}}
\par
\noindent

{ \setstretch{1.4}
\vfill
\noindent {\huge \textbf{\textsf{\emph{PC\_geomorph\_roughness}}}}
\vskip 1em
{\Large \textsf{Pre-process and classify lidar or SfM point-cloud data for processing
with \emph{PC\_geomorph\_roughness}}}
\vskip 2em
\noindent
{\Large \textsf{Bodo Bookhagen (\url{bodo.bookhagen@uni-potsdam.de})}
\vfill
}

\noindent
\includegraphics[width=360pt, left]{figs/pozotitle.png}

\textsf{December 2018}}
\end{flushleft}
\end{titlepage}
\restoregeometry

%%
%% end titlepage
%%


\renewcommand*\contentsname{Table of Contents}
{
\hypersetup{linkcolor=}
\setcounter{tocdepth}{3}
\tableofcontents
\newpage
}
\hypertarget{point-cloud-pc-geomorphologic-roughness-analysis}{%
\section{Point Cloud (PC) Geomorphologic roughness
analysis}\label{point-cloud-pc-geomorphologic-roughness-analysis}}

This document-in-manual-style roughly outlines the steps necessary to
take an unclassified, raw point cloud (PC), perform a ground
classification using commercial or open-source tools, generate Digital
Elevation Models (DEMs), calculate PC statistics for selected seed
points (user inputs spacing), and generate interpolated GeoTIFF files
for further processing and analysis.

\textbf{The algorithm and an application for this code is described in:
\emph{Bingham, N., Bookhagen, B., Johnson, K., and Chadwick, O.} (in
review): Use of lidar point cloud data to assess human-induced erosion
and loss of vegetation cover on contrasting lithologies}

\textbf{When using the code, please cite this paper!}

\hypertarget{installation}{%
\section{Installation}\label{installation}}

\emph{The preferred system to run this code is a Linux derivative, but
using OS X or the Windows 10 Bash setup with Ubuntu will work as well.
It will require additional work to make the code function on a Windows
10 only system without bash support.}

\hypertarget{installation-on-windows-10}{%
\subsection{Installation on Windows
10}\label{installation-on-windows-10}}

Installation works best, if you use the Windows 10 Bash. There are
several resources available on the internet that explain the
\href{https://www.windowscentral.com/how-install-bash-shell-command-line-windows-10}{bash
setup}. After the reboot, \emph{wget}
\href{https://conda.io/miniconda.html}{miniconda} for
\href{https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh}{Linux
64 bit} and install:

\begin{lstlisting}[language=bash]
wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh
bash Miniconda3-latest-Linux-x86_64.sh
\end{lstlisting}

Next, call:

\begin{lstlisting}[language=bash]
conda config --prepend channels conda-forge/label/dev
conda config --prepend channels conda-forge
conda create -y -n PC_py3 python=3.6 pip scipy pandas numpy matplotlib \
    scikit-image gdal pdal xarray packaging ipython multiprocess \
    h5py lastools pykdtree spyder gmt=5* imagemagick
\end{lstlisting}

Activate the environment and install laspy

\begin{lstlisting}[language=bash]
source activate PC_py3
pip install laspy
\end{lstlisting}

If you have LAStools installed, set the path within the bash.

\begin{lstlisting}[language=bash]
export PATH=/mnt/c/LAStools/bin:$PATH
\end{lstlisting}

\hypertarget{installation-on-linux}{%
\subsection{Installation on Linux}\label{installation-on-linux}}

This is a Python 3.x code that will run on any OS, which supports the
packages. It runs and has been tested on Linux (Ubuntu/Debian), Windows
10, and Mac OS X. We are using
\href{https://conda.io/docs/}{conda/miniconda} to install the required
packages, which can be \href{https://conda.io/miniconda.html}{downloaded
here}. Follow
\href{https://conda.io/docs/user-guide/install/index.html}{these
instruction} to get miniconda installed. In short:

\begin{lstlisting}[language=bash]
wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh
bash Miniconda3-latest-Linux-x86_64.sh
\end{lstlisting}

You will need several packages for python to run this code. These are
standard packages and are included in all distributions. We create an
environment called \emph{PC\_py3} (PointCloud-python3) in the following
way (currently we are using Python 3.6, but 3.7 should work equally
well):

\begin{lstlisting}[language=bash]
conda config --prepend channels conda-forge/label/dev
conda config --prepend channels conda-forge
conda create -y -n PC_py3 python=3.6 pip scipy pandas numpy matplotlib \
    scikit-image gdal pdal xarray packaging ipython multiprocess \
    h5py lastools pykdtree spyder gmt=5* imagemagick
\end{lstlisting}

You can active this environment on the command line with
\passthrough{\lstinline!source activate PC\_py3!}.

You don't need ipython or spyder to run this code and you can remove
these repositories in the command line above, but they usually come in
handy. Also, we are installing GMT5 for visualization purposes. If you
don't plan to generate maps and/or use GMT, you can safely remove
\emph{gmt=5*} and \emph{imagemagick} from the line above.

Next, Install a fast and simple LAS/LAZ reader/writer. You can do
similar steps through \emph{lastools}, but this interface is fairly
simple to use. \emph{Please note that laspy currently does not support
writing LAZ files.}

\begin{lstlisting}[language=bash]
source activate PC_py3
pip install laspy
\end{lstlisting}

If you have issues with pip, see:
\href{https://stackoverflow.com/questions/47955397/pip3-error-namespacepath-object-has-no-attribute-sor}{here}.

This code uses \href{https://github.com/storpipfugl/pykdtree}{pykdtree}.
There are other KDTree implementations, for example
\href{https://docs.scipy.org/doc/scipy-0.19.1/reference/generated/scipy.spatial.cKDTree.html}{scipy.spatial.cKDTree}.
But pykdtree is faster (but doesn't allow you to save the results such
as cKDTree). Because we aim at processing very large point clouds, the
pyKDTree algorithm is significantly faster for generating and querying
the KDtree and will increase processing speed (we have run tests with
1e6 to 1e9 points).

\hypertarget{installation-of-pc_geomorph_roughness}{%
\subsection{\texorpdfstring{Installation of
\emph{PC\_geomorph\_roughness}}{Installation of PC\_geomorph\_roughness}}\label{installation-of-pc_geomorph_roughness}}

After the setup either on Ubuntu or Windows 10 Bash, install the
repository into your favorite github directory, for example
\textasciitilde{}/github:

\begin{lstlisting}[language=bash]
cd ~/github
git clone https://github.com/UP-RS-ESP/PC_geomorph_roughness
\end{lstlisting}

\emph{You are now ready to run the code from the command line.}

\hypertarget{install-lastools}{%
\subsection{Install LAStools}\label{install-lastools}}

\hypertarget{install-lidar2dem}{%
\subsection{Install lidar2dem}\label{install-lidar2dem}}

The python-based tool
\href{http://applied-geosolutions.github.io/lidar2dems/}{lidar2dem} is a
Python2 based list of modules and script. This is a useful
implementation if you aim to classify many files in individual
directories and convert them to a DTM. A nice workflow is provided. To
take full advantage of some of the code's capabilities, we first need to
install a python2-based environment:

\begin{lstlisting}[language=bash]
conda create -y -n PC_py2 python=2* pip scipy pandas numpy matplotlib \
    scikit-image gdal pdal xarray packaging ipython multiprocess \
    h5py lastools pykdtree spyder gmt=5* imagemagick
source activate PC_py2
\end{lstlisting}

Installation into the home directory (alternatively, if sudo rights are
available, install into /usr/local/src):

\begin{lstlisting}[language=bash]
source activate PC_py2
pip install gippy 
cd ~
git clone https://github.com/Applied-GeoSolutions/lidar2dems.git
cd lidar2dems
./setup.py install
\end{lstlisting}

You are now ready to use \emph{l2d\_classify} and other tools from the
lidar2dem scripts.

\hypertarget{install-points2grid}{%
\subsection{Install points2grid}\label{install-points2grid}}

The code points2grid provides a useful environment for interpolating
large, classified points. It does not classify a PC, but takes a
classified PC and generates a DEM (or Digital Terrain Model) from it by
local interpolation of the points. For more information see
\href{http://opentopo.sdsc.edu/tools/viewTool?toolId=201}{OpenTopography
points2grid webpage}, the
\href{https://github.com/CRREL/points2grid/}{CRREL github webpage}, and
follow the
\href{https://github.com/CRREL/points2grid/blob/master/INSTALL.md}{Installation
description}. In short, these are:

\begin{lstlisting}[language=bash]
source activate PC_py3
conda install libcurl
cd ~
mkdir bin
git clone https://github.com/CRREL/points2grid.git
cd points2grid
mkdir build 
cd build
cmake .. -DCMAKE_INSTALL_PREFIX="~/"
make -j
make install
\end{lstlisting}

Make sure to add the path \emph{\textasciitilde{}/bin} to the path
variable

\begin{lstlisting}[language=bash]
export PATH=~/bin:$PATH
export LD_LIBRARY_PATH=~/lib:$LD_LIBRARY_PATH
\end{lstlisting}

and you may want to add this permanently to your \emph{.bashrc}:

\begin{lstlisting}[language=bash]
echo "export PATH=~/bin:$PATH" >> ~/.bashrc
echo "export LD_LIBRARY_PATH=~/lib:$LD_LIBRARY_PATH" >> ~/.bashrc
\end{lstlisting}

\hypertarget{point-cloud-pc-classification}{%
\section{Point Cloud (PC)
Classification}\label{point-cloud-pc-classification}}

\textbf{PC classification is not part of the manuscript and algorithm
described. Here, we show two approaches how to ground-classify a PC. You
may know of others (and there are certainly many different ways to
ground-classify PCs).}

\emph{We describe ground-classification using the commercial
\href{https://rapidlasso.com/lastools/}{LAStools} package and an
open-source approach with \href{https://pdal.io/}{PDAL}.}

We focus on our analysis on three subcatchments in the Pozo catchments
(example\_01, example\_01m example\_03). An oblique view of the Pozo
catchment illustrates the steep terrain and diverse landcover (Figure
\ref{Fig:PC_Pozo_color_intensity}).

\begin{figure}
\centering
\includegraphics{./tex2pdf.-e6884bf2dada0f3b/d07363c5026266513a5e7ff14618cb2b3258d447.png}
\caption{Oblique view of the Pozo catchment in the southwestern part of
the Santa Cruz Island. For this area, we show the analysis of three
subcatchments in
\href{https://github.com/BodoBookhagen/PC_geomorph_roughness/tree/master/example_01}{example\_01},
\href{https://github.com/BodoBookhagen/PC_geomorph_roughness/tree/master/example_02}{example\_02},
and
\href{https://github.com/BodoBookhagen/PC_geomorph_roughness/tree/master/example_03}{example\_03}.
The left image illustrate RGB colors taken from a recent airphoto and
draped over the point clouds, the right view shows the intensity values
of the NIR lidar. There are n=69,301,579 points (all points, no
classification).\label{Fig:PC_Pozo_color_intensity}}
\end{figure}

\hypertarget{classification-with-lastools}{%
\subsection{Classification with
LAStools}\label{classification-with-lastools}}

\emph{NOTE: \href{https://rapidlasso.com/lastools/}{LAStools} is a
commercial code and requires a license to be fully functional. An
alternative to LAStools is described using PDAL's implementation of
SMRF.}

First, we clip the catchment with
\href{https://rapidlasso.com/lastools/lasclip/}{lasclip} from a larger
LAZ file containing \textasciitilde{}69 Mio. points for the southwestern
part of Santa Cruz Island (Figure \ref{Fig:PC_Pozo_color_intensity}).
These data are stored in file \emph{Pozo\_USGS\_UTM11\_NAD83\_
all\_color\_nocl.laz} (not provided with these example, because it is
too large for storage on github). But the entire dataset is freely
available and can be obtained at
\href{https://opentopography.org/}{OpenTopography}.

\hypertarget{clipping-a-pc}{%
\subsubsection{Clipping a PC}\label{clipping-a-pc}}

We use a shapefile in the same projection as the LAZ pointcloud to
extract the subsetted, unclassified pointcloud. We have buffered this
shapefile by 50m to make sure to include points from outside the
drainage divide (derived from a 1m DEM) to avoid artifacts. Here we
demonstrate this for catchment
\href{https://github.com/BodoBookhagen/PC_geomorph_roughness/tree/master/example_01}{example\_01}
(also called catchment 16).

\emph{NOTE: Because we run these examples on an Ubuntu system, we use
wine. If you are on a Mac OSX, the commands will be similar. On a
Windows system, you can just use the .exe files (e.g., lasinfo.exe - if
you have set the path variable correctly as shown above). }

\begin{lstlisting}[language=bash]
cd example_01
wine /opt/LAStools/bin/lasclip.exe -i ../Pozo_USGS_UTM11_NAD83_all_color_nocl.laz -poly Pozo_DTM_noveg_UTM11_NAD83_cat16_b50m.shp -o Pozo_USGS_UTM11_NAD83_cat16.laz
\end{lstlisting}

The resulting point cloud has 1,245,618 points. Often, PCs from other
sources come with pre-classified points. These often have not been
verified and we suggest to remove previous classification and user flags
with \href{https://rapidlasso.com/lastools/lasclassify/}{lasclassify}.

\begin{lstlisting}[language=bash]
wine /opt/LAStools/bin/lasclassify.exe -i Pozo_USGS_UTM11_NAD83_cat16.laz -olaz -set_user_data 0 -set_classification 0 -o Pozo_USGS_UTM11_NAD83_cat16_uncl.laz
\end{lstlisting}

Next, we obtain PC density information using
\href{https://rapidlasso.com/lastools/lasinfo/}{lasinfo}:

\begin{lstlisting}
wine /opt/LAStools/bin/lasinfo.exe -i Pozo_USGS_UTM11_NAD83_cat16_uncl.laz -nh -nv -nmm -cd

lasinfo (180422) report for 'Pozo_USGS_UTM11_NAD83_cat16_uncl.laz'
number of first returns:        1234002
number of intermediate returns: 149
number of last returns:         1236327
number of single returns:       1224860
covered area in square units/kilounits: 152992/0.15
point density: all returns 8.14 last only 8.08 (per square units)
      spacing: all returns 0.35 last only 0.35 (in units)
overview over number of returns of given pulse: 1224860 20255 503 0 0 0 0
\end{lstlisting}

\hypertarget{optional-pc-pre-processing}{%
\subsubsection{Optional PC
pre-processing}\label{optional-pc-pre-processing}}

If you know you have a noisy dataset (for example from SfM data), filter
by noise and isolated points:

\begin{lstlisting}[language=bash]
wine /opt/LAStools/bin/lasnoise.exe -i Pozo_USGS_UTM11_NAD83_cat16_uncl.laz -step_xy 2 -step_z 1 -isolated 5 -olaz -o Pozo_USGS_UTM11_NAD83_cat16_uncln.laz
\end{lstlisting}

\emph{NOTE: If you have SfM data you likely will need to do additional
pre-processing steps to clean up your point cloud. }

\hypertarget{pc-ground-classification}{%
\subsubsection{PC ground
classification}\label{pc-ground-classification}}

Next, we perform the actual PC ground classification using
\href{https://rapidlasso.com/lastools/lasground/}{lasground}. There are
many different options and these likely will need to be fine tuned and
adjusted to your area. Make sure to read the
\href{http://www.cs.unc.edu/~isenburg/lastools/download/lasground_README.txt}{README}
and understand the various parameters. Alternative to lasground you may
consider using PDAL's implementation of SMRF (see below and
\href{https://pdal.io/workshop/exercises/analysis/ground/ground.html}{guide}).

\begin{lstlisting}[language=bash]
wine /opt/LAStools/bin/lasground.exe -i Pozo_USGS_UTM11_NAD83_cat16_uncln.laz -by_flightline -wilderness -extra_fine -offset 0.25 -stddev 20 -step 1 -spike 0.5 -bulge 0.5 -olaz -o Pozo_USGS_UTM11_NAD83_cat16_clg.laz 
\end{lstlisting}

In the above steps, we ground-classify the PC. Ground points are
assigned the class=2. There are several options to chose from: We allow
an extra offset of 0.25m (25cm) and thereby include points to the ground
class that may otherwise be filtered out. This is based on visual
inspection of the results. Because the the point cloud is fairly dense
(\textasciitilde{}8 pts/m2), we use a step size of 1m (Figure
\ref{Fig:PC_cat16_color_intensity}).

\begin{figure}
\centering
\includegraphics{./tex2pdf.-e6884bf2dada0f3b/ec71bbd9408c7d02a445fee1c87a46d4926a9ea8.png}
\caption{Oblique view of subcatchment 16 in the Pozo catchment. Left
view shows the intensity image, right side shows the ground-classified
PC (white points are unclassified, brown-yellow colors indicate ground
points). There are n=1,245,618 total points (all points, no
classification), 231,928 unclassified (class=1), and 1,013,690 ground
(class=2) points.\label{Fig:PC_cat16_color_intensity}}
\end{figure}

If you prefer to use a stricter classification (i.e., fewer ground
points are identified), you can use the standard parameters (but these
are not fine tuned to the rough terrain of the Santa Cruz Island.

\begin{lstlisting}[language=bash]
wine /opt/LAStools/bin/lasground.exe -i Pozo_USGS_UTM11_NAD83_cat16_uncln.laz -by_flightline -wilderness -extra_fine -olaz -o Pozo_USGS_UTM11_NAD83_cat16_clg_normal.laz 
\end{lstlisting}

\emph{NOTE: You should always visually inspect your classified points
using \href{http://c42f.github.io/displaz/}{displaz} or
\href{https://www.danielgm.net/cc/}{CloudCompare} or something similar
to make sure that the point-cloud classification performed well in the
crucial areas.} If you are not satisfied with your classification, you
may want to experiment with
\href{https://www.cs.unc.edu/~isenburg/lastools/download/lasground_new_README.txt}{lasground\_new}:

\begin{lstlisting}[language=bash]
wine /opt/LAStools/bin/lasground_new.exe -i Pozo_USGS_UTM11_NAD83_cat16_uncln.laz -wilderness -extra_fine -olaz -o Pozo_USGS_UTM11_NAD83_cat16_clg_lasground_new.laz 
\end{lstlisting}

\emph{NOTE: We emphasize the importance of properly classifying your
point cloud. If you have all natural terrain, it will be important to
distinguish between ground and vegetation. In urban or suburban areas,
you may want to further distinguish buildings from bare-earth lidar
returns. It is essential that you spent time on the classification
before proceeding with the analysis.}

Once you have identified the best point-cloud classification, you can
save only the ground points to a separate file (i.e., a file containing
only ground points). This will be used for the analysis with
\emph{PC\_geomorph\_roughness}.

\begin{lstlisting}[language=bash]
wine /opt/LAStools/bin/las2las.exe -i Pozo_USGS_UTM11_NAD83_cat16_clg.laz -keep_class 2 -olaz -o Pozo_USGS_UTM11_NAD83_cat16_clg_cl2.laz
\end{lstlisting}

\hypertarget{pc-vegetation-classification}{%
\subsubsection{PC vegetation
classification}\label{pc-vegetation-classification}}

For some applications it may be useful to have a vegetation class
defined. This can be achieved in several ways and the most straight
forward approach is to rely on
\href{https://rapidlasso.com/lastools/lasclassify/}{lasclassify}. This
is not required for running \emph{PC\_geomorph\_roughness}, but still
may come in useful. In order for lasclassify to work, you will need to
store the height above ground for every point. This can be achieved by
running lasground with the option \emph{-compute\_height}. Assuming your
lasground parameters are the first example from above (without
-compute\_height), we use:

\begin{lstlisting}[language=bash]
wine /opt/LAStools/bin/lasheight.exe -i Pozo_USGS_UTM11_NAD83_cat16_clg.laz -olaz -o Pozo_USGS_UTM11_NAD83_cat16_clgh.laz 
\end{lstlisting}

Alternatively, you can attempt to run the height computation during the
lasground classification, but this prevents the \emph{-by\_flightline}
option:

\begin{lstlisting}[language=bash]
wine /opt/LAStools/bin/lasground.exe -i Pozo_USGS_UTM11_NAD83_cat16_uncln.laz  -wilderness -extra_fine -offset 0.25 -stddev 20 -step 1 -spike 0.5 -bulge 0.5 -olaz -compute_height -o Pozo_USGS_UTM11_NAD83_cat16_clgh.laz 
\end{lstlisting}

The file containing height information stored in the user-data flag can
be used for further classification:

\begin{lstlisting}[language=bash]
wine /opt/LAStools/bin/lasclassify.exe -i Pozo_USGS_UTM11_NAD83_cat16_clgh.laz -ground_offset 0.5 -planar 0.1 -rugged 0.6 -olaz -o Pozo_USGS_UTM11_NAD83_cat16_clghc.laz 
\end{lstlisting}

The important options here are \emph{-ground\_offset} that determines
the minimum height of vegetation or buildings. For the Santa Cruz
Island, this can be set to a lower value of 0.5m. This will only
consider points 0.5m above the ground to determine vegetation or
buildings (often 1.5 or 2m are used). The options \emph{-planar} and
\emph{-rugged} allow to control the identification of roofs (planar) and
trees (rugged). In the study area, no buildings exist, but different
vegetation types, so we have increased the rugged value. The results
indicate a reasonable classification of vegetation (Figure
\ref{Fig:PC_cat16_lower_color_intensity_classification}).

\begin{figure}
\centering
\includegraphics{./tex2pdf.-e6884bf2dada0f3b/26de11cc0ff559d250c2a0060dab393618c09ab4.png}
\caption{Oblique view of the lower part of subcatchment 16 in the Pozo
catchment. Left view shows the color image, middle image is the lidar
intensity, right side shows the ground and vegetation-classified PC
(brown-yellow colors indicate ground, green vegetation, and white points
are unclassified). Further optimization could increase the detection
limit of vegetation to include some of the lower brushes by decreasing
the -ground\_offset parameters (e.g., -ground\_offset 0.35) and
increasing the -rugged parameter (e.g., -rugged
0.8).\label{Fig:PC_cat16_lower_color_intensity_classification}}
\end{figure}

\hypertarget{dtm-from-ground-classified-pcs}{%
\subsubsection{DTM from ground-classified
PCs}\label{dtm-from-ground-classified-pcs}}

Next, we generate a DTM from the ground-classified point cloud using
\href{https://rapidlasso.com/blast/blast2dem/}{blast2dem}. This creates
a TIN model of the surfaces and samples this at the required intervals.
The output is stored in the subdirectory \emph{dtm\_interp}
(interpolated Digital Terrain Model).

\begin{lstlisting}[language=bash]
mkdir dtm_interp
wine /opt/LAStools/bin/blast2dem.exe -keep_class 2 -utm 11N -nad83 -meter -elevation_meter -merged -step 1 -i Pozo_USGS_UTM11_NAD83_cat16_clg_cl2.laz -o dtm_interp/Pozo_USGS_UTM11_NAD83_cat16_clg_cl2_1m.tif
\end{lstlisting}

If you intend to create a hillshade image for visualization, for example
in QGIS, use:

\begin{lstlisting}[language=bash]
wine /opt/LAStools/bin/blast2dem.exe -keep_class 2 -hillshade -utm 11N -nad83 -meter -elevation_meter -merged -step 1 -i Pozo_USGS_UTM11_NAD83_cat16_clg_cl2.laz -o dtm_interp/Pozo_USGS_UTM11_NAD83_cat16_clg_cl2_1m_HS.tif
\end{lstlisting}

In order to compare the outputs from the other classification schemes,
we perform the same gridding on the other ground-classified PC
(lasground\_normal and lasground\_new):

\begin{lstlisting}[language=bash]
wine /opt/LAStools/bin/blast2dem.exe -keep_class 2 -utm 11N -nad83 -meter -elevation_meter -merged -step 1 -i Pozo_USGS_UTM11_NAD83_cat16_clg_normal.laz -o dtm_interp/Pozo_USGS_UTM11_NAD83_cat16_clg_cl2_normal_1m.tif
wine /opt/LAStools/bin/blast2dem.exe -keep_class 2 -utm 11N -nad83 -meter -elevation_meter -merged -step 1 -i Pozo_USGS_UTM11_NAD83_cat16_clg_lasground_new.laz -o dtm_interp/Pozo_USGS_UTM11_NAD83_cat16_clg_cl2_\
lasground_new_1m.tif
\end{lstlisting}

The resulting grids (Figures \ref{Fig:Cat16_lasground_comparison} and
\ref{Fig:Cat16_lasground_diff}) indicate some differences (hillshade and
DEM differences), but overall the classifications are comparable. Still,
for detailed PC analysis it is important to have especially the low and
high points properly classified.

\emph{NOTE: Before we can compare the grid, we will need to ensure that
they are aligned to each other. The safest (and easiest) way of doing
that is to make certain that the UTM coordinates of the grid (or
GeoTIFF) is aligned with integer UTM coordinates. Second, we also want
to cut the regions outside the catchment to avoid including border
artifacts.}

These steps have been included in the
\href{https://github.com/BodoBookhagen/PC_geomorph_roughness/blob/master/example_01/example01_create_DEM_comparison_ground_classification_gmt.sh}{GMT
bash shell file}. This can be achieved with:

\begin{lstlisting}[language=bash]
DEM1=dtm_interp/Pozo_USGS_UTM11_NAD83_cat16_clg_cl2_1m.tif
SHAPEFILE=Pozo_DTM_noveg_UTM11_NAD83_cat16.shp
gdalwarp $DEM1 foo.tif -tap -tr 1 1 -r bilinear -cutline $SHAPEFILE -crop_to_cutline -co COMPRESS=DEFLATE -co ZLEVEL=7 -co predictor=3
\end{lstlisting}

\begin{figure}
\centering
\includegraphics[width=\textwidth,height=0.9\textheight]{./tex2pdf.-e6884bf2dada0f3b/e1ed19ada7b4115e0fb8f02db69692fdf655382e.png}
\caption{Map view of the adjusted lasground (top), normal lasground
(middle), and lasground\_new (bottom) outputs. Small differences are
visible. This map comparison has been created with GMT (see
\href{https://github.com/BodoBookhagen/PC_geomorph_roughness/blob/master/example_01/example01_create_DEM_comparison_ground_classification_gmt.sh}{GMT
script}).\label{Fig:Cat16_lasground_comparison}}
\end{figure}

\begin{figure}
\centering
\includegraphics[width=\textwidth,height=0.9\textheight]{./tex2pdf.-e6884bf2dada0f3b/66cee76fec3bc8d450003947c982939572449c91.png}
\caption{Map view of the difference (Delta H) between adjusted lasground
and lasground-normal (middle), and lasground\_new (bottom) outputs.
Small differences are visible, especially where vegetation cover is
high. This map comparison has been created with GMT (see
\href{https://github.com/BodoBookhagen/PC_geomorph_roughness/blob/master/example_01/example01_create_DEM_comparison_ground_classification_gmt.sh}{GMT
script}).\label{Fig:Cat16_lasground_diff}}
\end{figure}

\hypertarget{comparison-of-ground-classified-pcs}{%
\subsubsection{Comparison of ground-classified
PCs}\label{comparison-of-ground-classified-pcs}}

A more direct way of comparison at the point-cloud level is to calcuate
the \href{https://pdal.io/apps/hausdorff.html}{Hausdorff Distance}. Here
we use the adjusted lasground classification as a reference PC and first
create ground-classified LAZ files:

\begin{lstlisting}[language=bash]
wine /opt/LAStools/bin/las2las.exe -i Pozo_USGS_UTM11_NAD83_cat16_clg.laz -keep_class 2 -olaz -o Pozo_USGS_UTM11_NAD83_cat16_clg_cl2.laz
wine /opt/LAStools/bin/las2las.exe -i Pozo_USGS_UTM11_NAD83_cat16_clg_lasground_new.laz -keep_class 2 -olaz -o Pozo_USGS_UTM11_NAD83_cat16_clg_lasground_new_cl2.laz
wine /opt/LAStools/bin/las2las.exe -i Pozo_USGS_UTM11_NAD83_cat16_clg_normal.laz -keep_class 2 -olaz -o Pozo_USGS_UTM11_NAD83_cat16_clg_normal_cl2.laz
pdal hausdorff Pozo_USGS_UTM11_NAD83_cat16_clg_cl2.laz Pozo_USGS_UTM11_NAD83_cat16_clg_normal_cl2.laz
pdal hausdorff Pozo_USGS_UTM11_NAD83_cat16_clg_cl2.laz Pozo_USGS_UTM11_NAD83_cat16_clg_lasground_new_cl2.laz
\end{lstlisting}

The Hausdorff distance between the PCs classified with the adjusted
parameters and with standard parameters is:

\begin{lstlisting}
{
  "filenames":
  [
    "Pozo_USGS_UTM11_NAD83_cat16_clg_cl2.laz",
    "Pozo_USGS_UTM11_NAD83_cat16_clg_normal_cl2.laz"
  ],
  "hausdorff": 5.090078585,
  "pdal_version": "1.7.2 (git-version: a71df1)"
}
\end{lstlisting}

The Hausdorff distance between the PCs classified with the adjusted
parameters and with a revised version of lasground is:

\begin{lstlisting}
{
  "filenames":
  [
    "Pozo_USGS_UTM11_NAD83_cat16_clg_cl2.laz",
    "Pozo_USGS_UTM11_NAD83_cat16_clg_lasground_new_cl2.laz"
  ],
  "hausdorff": 3.1808961,
  "pdal_version": "1.7.2 (git-version: a71df1)"
}
\end{lstlisting}

\hypertarget{processing-with-pdal}{%
\subsection{Processing with PDAL}\label{processing-with-pdal}}

PDAL is an open-source point cloud library that provides easy access to
the \href{http://pointclouds.org/}{PCL}. It is very powerful, but not
specifically designed to process lidar or SfM PCs. However, it provides
some simple approaches to ground-classify terrain that we will explore
here \emph{NOTE: Vegetation classification with PDAL is possible, but
requires several steps. These are not covered in this manual.}

\hypertarget{ground-classification-with-pdals-implementation-of-smrf}{%
\subsubsection{Ground classification with PDAL's implementation of
SMRF}\label{ground-classification-with-pdals-implementation-of-smrf}}

We rely on the Simple Morphological Filter
\href{https://pdal.io/stages/filters.smrf.html\#filters-smrf}{SMRF} that
can be accessed through \emph{pdal translate} (or use your own
pipeline). There is a step-by-step
\href{https://pdal.io/workshop/exercises/analysis/ground/ground.html}{instruction}.

\begin{lstlisting}[language=bash]
pdal translate \
   Pozo_USGS_UTM11_NAD83_cat16.laz \
   -o Pozo_USGS_UTM11_NAD83_cat16_smrf.las \
   smrf 
\end{lstlisting}

\emph{NOTE: On some miniconda/anaconda installation, the writing to LAZ
(compressed LAS) files is not supported. Change the output filename to
.las instead.}

There are several options to adjust, especially
\emph{--filters.smrf.scalar}, \emph{-filters.smrf.slope},
\emph{-filters.smrf.threshold}, and \emph{--filters.smrf.window}. But
the standard options provide reasonable results (Figure
\ref{Fig:PC_cat16_intensity_smrf_pmf_classification}).

If you would like to save ground-class only points to a separate file,
use the range filter:

\begin{lstlisting}[language=bash]
pdal translate Pozo_USGS_UTM11_NAD83_cat16_smrf.las -o Pozo_USGS_UTM11_NAD83_cat16_smrf_cl2.las
range --filters.range.limits="Classification[2:2]"
\end{lstlisting}

You can combine this with the ground-classification into:

\begin{lstlisting}[language=bash]
pdal translate \
   Pozo_USGS_UTM11_NAD83_cat16.laz \
   -o Pozo_USGS_UTM11_NAD83_cat16_smrf_cl2.las \
   smrf range --filters.range.limits="Classification[2:2]"
\end{lstlisting}

In addition, you can include a simple outliers filter, ignore noise
points (usually class=7) and save only the ground-classified points:

\begin{lstlisting}[language=bash]
pdal translate \
   Pozo_USGS_UTM11_NAD83_cat16.laz \
   -o Pozo_USGS_UTM11_NAD83_cat16_smrf_cl2.las \
   outlier smrf range \
   --filters.outlier.method="statistical" \
   --filters.outlier.mean_k=8 \
   --filters.outlier.multiplier=3.0 \
   --filters.smrf.ignore="Classification[7:7]" \
   --filters.range.limits="Classification[2:2]" \
   --writers.las.compression=true
\end{lstlisting}

These results are comparable to the adjusted lasground parameters. The
Hausdorff distance is comparable to LAStools' adjusted lasground
classifications.

\begin{lstlisting}[language=bash]
pdal hausdorff Pozo_USGS_UTM11_NAD83_cat16_clg_cl2.laz Pozo_USGS_UTM11_NAD83_cat16_smrf_cl2.las
\end{lstlisting}

The Hausdorff distance is

\begin{lstlisting}
{
  "filenames":
  [
    "Pozo_USGS_UTM11_NAD83_cat16_clg_cl2.laz",
    "Pozo_USGS_UTM11_NAD83_cat16_smrf_cl2.las"
  ],
  "hausdorff": 4.910509139,
  "pdal_version": "1.7.2 (git-version: a71df1)"
}
\end{lstlisting}

\hypertarget{ground-classification-with-pdals-implementation-of-pmf}{%
\subsubsection{Ground classification with PDAL's implementation of
PMF}\label{ground-classification-with-pdals-implementation-of-pmf}}

Next, we use the Progressive Morphological Filter
\href{https://pdal.io/stages/filters.pmf.html\#filters-pmf}{PMF} that
can be accessed through pdal translate (or use your own pipeline):

\begin{lstlisting}[language=bash]
pdal translate \
   Pozo_USGS_UTM11_NAD83_cat16.laz \
   -o Pozo_USGS_UTM11_NAD83_cat16_pmf.las \
   pmf 
\end{lstlisting}

The PMF filter will require setting additional parameters to use it for
ground classification of the Pozo-catchment data (Figure
\ref{Fig:PC_cat16_intensity_smrf_pmf_classification}).

\begin{lstlisting}[language=bash]
pdal translate \
   Pozo_USGS_UTM11_NAD83_cat16.laz \
   -o Pozo_USGS_UTM11_NAD83_cat16_pmf.las \
   pmf \
   --filters.pmf.slope=2 \
   --filters.pmf.exponential=false \
   --filters.pmf.initial_distance=1 \
   --filters.pmf.max_distance=4
\end{lstlisting}

Or combined into one longer code block with filtering and writing only
class 2 points:

\begin{lstlisting}[language=bash]
pdal translate \
   Pozo_USGS_UTM11_NAD83_cat16.laz \
   -o Pozo_USGS_UTM11_NAD83_cat16_smrf_cl2.laz \
   outlier pmf range \
   --filters.outlier.method="statistical" \
   --filters.outlier.mean_k=8 \
   --filters.outlier.multiplier=3.0 \
   --filters.pmf.ignore="Classification[7:7]" \
   --filters.pmf.slope=2 \
   --filters.pmf.exponential=false \
   --filters.pmf.initial_distance=1 \
   --filters.pmf.max_distance=4
   --filters.range.limits="Classification[2:2]" \
   --writers.las.compression=true
\end{lstlisting}

However, even with these aggressive filtering options, the PMF doesn't
perform well in the very steep and rugged terrain of Santa Cruz Island.

\begin{figure}
\centering
\includegraphics{./tex2pdf.-e6884bf2dada0f3b/6f9b83a6cc07396761bc6c7a3994c70088d3fbac.png}
\caption{Oblique view of the lower part of subcatchment 16 in the Pozo
catchment. Left view shows the lidar intensity image, middle is ground
classification using PDAL's implementation of SMRF, right image uses
PDAL's implementation of PMF (brown-yellow colors indicate ground and
white points are unclassified). PMF will require setting additional
parameters (see \href{https://pdal.io/stages/filters.pmf.html}{PDAL
filter webpage}), SMRF generates reasonable results with standard
options.\label{Fig:PC_cat16_intensity_smrf_pmf_classification}}
\end{figure}

\hypertarget{generating-a-dtm-with-pdal}{%
\subsubsection{Generating a DTM with
PDAL}\label{generating-a-dtm-with-pdal}}

You can interpolate the ground-classified points from SMRF onto a
gridded DEM using
\href{https://pdal.io/workshop/exercises/analysis/dtm/dtm.html}{pdal's
DTM pipeline}. This approach relies on
\href{https://pdal.io/stages/writers.gdal.html\#writers-gdal}{writers.gdal},
which in turn relies on
\href{https://opentopography.org/otsoftware/points2grid}{Points2Grid}.
For gdal.writes currently exists no command line support. Generate a
file containing the necessary information to run a PDAL pipeline (call
it \emph{example01\_gdal\_smrf.json}). For the SMRF ground-classified
file, we use:

\emph{NOTE: You may want to look into otbcli\_splitimage -in
\textless{}in\_file.tif\textgreater{} -out
\textless{}out\_file.tif\textgreater{} if you have trouble reading the
tif file.}

\begin{lstlisting}
{
"pipeline": [
    "Pozo_USGS_UTM11_NAD83_cat16_smrf_cl2.las",
    {
        "filename":"dtm_interp/Pozo_USGS_UTM11_NAD83_cat16_smrf_cl2_Zmean.tif",
        "gdaldriver":"GTiff",
        "data_type":"float",
        "dimension":"Z",
        "output_type":"mean",
        "resolution":"1.0",
        "type": "writers.gdal"
    }
]
}
\end{lstlisting}

Then run this with:

\begin{lstlisting}[language=bash]
pdal pipeline --nostream example01_gdal_smrf.json
\end{lstlisting}

You can extract additional \emph{output\_type}, for example idw, stdev,
count. Most importantly, you can overwrite existing parameters on the
command line with:

\begin{lstlisting}[language=bash]
pdal pipeline --nostream example01_gdal_smrf.json \
    --writers.gdal.dimension="Intensity" \
    --writers.gdal.data_type="float" \
    --writers.gdal.output_type="mean" \
    --writers.gdal.filename=\
    "dtm_interp/Pozo_USGS_UTM11_NAD83_cat16_smrf_cl2_intensity_mean.tif"
\end{lstlisting}

In a second step and in order to compare the interpolation algorithms
from classified point clouds, we use the same PC (classified with the
adjusted lasground parameters) and use blast2dem compared to the local
points2grid interpolation scheme implemented in gdal.writer. We generate
the pipeline \emph{example01\_gdal\_lasground.json}:

\begin{lstlisting}
{
"pipeline": [
    "Pozo_USGS_UTM11_NAD83_cat16_clg_cl2.laz",
    {
        "filename":"dtm_interp/Pozo_USGS_UTM11_NAD83_cat16_lasground_cl2_Zmean.tif",
        "gdaldriver":"GTiff",
        "data_type":"float",
        "dimension":"Z",
        "output_type":"mean",
        "resolution":"1.0",
        "type": "writers.gdal"
    }
]
}
\end{lstlisting}

Then run this with:

\begin{lstlisting}[language=bash]
pdal pipeline --nostream example01_gdal_lasground.json
\end{lstlisting}

The output maps view of these interpolated surfaces are compared to
other gridding methods (Figure
\ref{Fig:Cat16_smrf_PDAL_intensity_diff}).

\begin{figure}
\centering
\includegraphics[width=\textwidth,height=0.85\textheight]{./tex2pdf.-e6884bf2dada0f3b/c1820159b77b07d3eb329d9de1686abfd1d6f527.png}
\caption{Map view of the PDAL SMRF classified DEM. Gridding was
performed through the PDAL's writer.gdal approach. Intensity (top) and
difference between adjusted lasground-classified PC and point2grid
interpolated DTM (middle) is shown. Bottom illustrates the differences
between the lasground-classified PC gridded with blast2dem minus
gdal.writer. Note that points with high curvature appear to show the
largest difference between the interpolation methods. See
\href{https://github.com/BodoBookhagen/PC_geomorph_roughness/blob/master/example_01/example01_create_DEM_PDAL_comparison_ground_classification_gmt.sh}{GMT
bash script}. \label{Fig:Cat16_smrf_PDAL_intensity_diff}}
\end{figure}

\hypertarget{combined-pdal-pipeline-using-filtering-steps-and-smrf-classification}{%
\subsubsection{Combined PDAL pipeline using filtering steps and SMRF
classification}\label{combined-pdal-pipeline-using-filtering-steps-and-smrf-classification}}

We can combine several steps in a PDAL pipeline to generate a
ground-classified PC. In this pipeline, we first assign the class 0 to
all points, perform an
\href{https://pdal.io/stages/filters.elm.html\#filters-elm}{Extended
Local Minimum} filter, remove
\href{https://pdal.io/stages/filters.outlier.html\#filters-outlier}{outliers},
perform
\href{https://pdal.io/stages/filters.smrf.html\#filters-smrf}{SMRF}
ground segmentation and only write the ground-classified files to a file
using a
\href{https://pdal.io/stages/filters.range.html\#filters-range}{range
filter}. The pipeline is stored in
\href{https://github.com/BodoBookhagen/PC_geomorph_roughness/blob/master/example_01/example01_PDAL_SMRF_pipeline.json}{example\_01/example01\_PDAL\_SMRF\_pipeline.json}:

\begin{lstlisting}
{
  "pipeline":[
    {
      "type":"filters.assign",
      "assignment":"Classification[:]=0"
    },
    {
      "type":"filters.elm",
      "cell":10.0,
      "threshold":2.0,
      "class":7
    },
    {
      "type":"filters.outlier"
    },
    {
      "type":"filters.smrf",
      "last":true,
      "ignore":"Classification[7:7]",
      "cell":1.0,
      "slope":0.2,
      "window":20,
      "threshold":0.8,
      "scalar":1.2
    },
    {
      "type":"filters.range",
      "limits":"Classification[2:2]"
    }
  ]
}
\end{lstlisting}

The pipeline is run with the following command:

\begin{lstlisting}[language=bash]
pdal translate Pozo_USGS_UTM11_NAD83_cat16.laz Pozo_USGS_UTM11_NAD83_cat16_SMRF_cl2.las --json example01_PDAL_SMRF_pipeline.json
\end{lstlisting}

This can be written to a DTM (nodata value = -9999) with the pipeline
\href{https://github.com/BodoBookhagen/PC_geomorph_roughness/blob/master/example_01/example01_writers_gdal_smrf_Zmean_1m.json}{example01\_writers\_gdal\_smrf\_Zmean\_1m.json}:

\begin{lstlisting}
{
"pipeline": [
    "Pozo_USGS_UTM11_NAD83_cat16_SMRF_cl2.las",
    {
        "filename":"dtm_interp/Pozo_USGS_UTM11_NAD83_cat16_smrf_cl2_Zmean_1m.tif",
        "gdaldriver":"GTiff",
        "output_type":"mean",
        "data_type":"float",
        "resolution":"1.0",
        "dimension":"Z",
        "type": "writers.gdal"
    }
]
}
\end{lstlisting}

and run with:

\begin{lstlisting}[language=bash]
pdal pipeline --nostream example01_writers_gdal_smrf_Zmean_1m.json
\end{lstlisting}

It is recommended that you clip that DEM with the shapefile outlining
the catchment to remove interpolation artifacts (remember, we have added
a 50m buffer for that reason). There are different ways of doing this,
here we use \href{https://www.gdal.org/gdalwarp.html}{gdalwarp}. We
first warp to a temporary file and then move the temporary file back to
the original file. Note the option \emph{-tap} that aligns the DEM to an
integers-spaced UTM grid:

\begin{lstlisting}[language=bash]
DEM_MN_GRD=dtm_interp/Pozo_USGS_UTM11_NAD83_cat16_smrf_cl2_Zmean.tif
SHAPEFILE=Pozo_DTM_noveg_UTM11_NAD83_cat16.shp
gdalwarp $DEM_MN_GRD foo.tif -tap -tr 1 1 -r bilinear -cutline $SHAPEFILE -crop_to_cutline -co COMPRESS=DEFLATE -co ZLEVEL=7 -co predictor=3
mv foo.tif $DEM_MN_GRD
\end{lstlisting}

\hypertarget{generating-a-dtm-with-from-a-pc-with-gdal}{%
\subsubsection{Generating a DTM with from a PC with
GDAL}\label{generating-a-dtm-with-from-a-pc-with-gdal}}

Alternatively, you can interpolate the points from a point cloud to a
gridded dataset using
\href{https://www.gdal.org/gdal_grid.html}{gdal\_grid}. There are more
versatile options available that allow to experiment with different
algorithms. This requires that the LAZ file will be written to a CSV or
similar file format that is readable by GDAL. In
\emph{PC\_geomorph\_roughness}, we use \emph{gdal\_grid} in the Python
code to interpolate the seed points written as CSV, converted to VRT
format to a grid.

First, write to CSV file using open-source las2las:

\begin{lstlisting}[language=bash]
las2las -i Pozo_USGS_UTM11_NAD83_cat16_smrf_cl2.las -o Pozo_USGS_UTM11_NAD83_cat16_smrf_cl2.csv -oparse xyz
\end{lstlisting}

Second, add a header X,Y,Z,c,i,R,G,B and replace
\textless{}space\textgreater{} with , :

\begin{lstlisting}[language=bash]
sed -i '1s/^/X,Y,Z\n/' \
    Pozo_USGS_UTM11_NAD83_cat16_smrf_cl2.csv
sed -i 's/ /,/g' \
    Pozo_USGS_UTM11_NAD83_cat16_smrf_cl2.csv
\end{lstlisting}

Third, create a VRT file to control how gdal is reading this file.
Create a file called \emph{Pozo\_USGS\_UTM11\_
NAD83\_cat16\_smrf\_cl2.vrt} with content:

\begin{lstlisting}
<OGRVRTDataSource>
    <OGRVRTLayer name="Pozo_USGS_UTM11_NAD83_cat16_smrf_cl2">
        <SrcDataSource>Pozo_USGS_UTM11_NAD83_cat16_smrf_\
        cl2.csv</SrcDataSource>
        <GeometryType>wkbPoint</GeometryType>
        <GeometryField encoding="PointFromColumns" x="X" y="Y" z="Z"/>
    </OGRVRTLayer>
</OGRVRTDataSource>
\end{lstlisting}

Fourth, we can convert the csv file to any GIS format. We use
\emph{ogr2ogr} for this. For example, converting it to a shapefile
format (make sure to set proper EPSG information for proper projection):

\begin{lstlisting}[language=bash]
ogr2ogr -oo KEEP_GEOM_COLUMNS=NO -oo GEOMETRY=AS_XYZ \
    -oo SEPARATOR=COMMA -oo AUTODETECT_WIDTH=YES \
    -oo HEADERS=AUTO -oo AUTODETECT_SIZE_LIMIT=0 \
    -oo AUTODETECT_TYPE=YES \
    -t_srs epsg:26911 -s_srs epsg:26911 \
    Pozo_USGS_UTM11_NAD83_cat16_smrf_cl2.shp \
    Pozo_USGS_UTM11_NAD83_cat16_smrf_cl2.vrt
\end{lstlisting}

Fifth, the shapefile can be interpolated to a grid using
\emph{gdal\_grid}. We need the following parameters:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  \emph{X and Y extent.} The output from

\begin{lstlisting}[language=bash]
ogrinfo -ro -so Pozo_USGS_UTM11_NAD83_cat16_smrf_cl2.shp Pozo_USGS_UTM11_NAD83_cat16_smrf_cl2
\end{lstlisting}

  can be piped throgh awk to obtain the extents:

\begin{lstlisting}[language=bash]
ogrinfo -ro -so Pozo_USGS_UTM11_NAD83_cat16_smrf_cl2.shp Pozo_USGS_UTM11_NAD83_cat16_smrf_cl2 | awk '/Extent: /'
\end{lstlisting}

  The xmin, ymin, and xmax, ymax values will need to be put into
  variables:

\begin{lstlisting}[language=bash]
xmin=236141.010000
ymin=3763743.940000
xmax=236824.920000
ymax=3764111.850000
\end{lstlisting}
\item
  \emph{Number of rows and columns.} We also define the number of rows
  and columns for a 1m DEM by calculating xmax-xmin and ymax-ymin.

\begin{lstlisting}[language=bash]
ncols=684
nrows=368
\end{lstlisting}
\item
  \emph{Defining the interpolation method.} \emph{gdal\_grid} allows
  several interpolation methods and we experiment with two: linear
  interpolation and inverse distance weighted (IDW). We define:

\begin{lstlisting}[language=bash]
linear="linear:radius1=2:radius2=3:angle=0.0:nodata=-9999"
\end{lstlisting}

  For IDW, we use a specific implementation that relies on nearest
  neighbor searching with an efficient way of defining a maximum number
  of neighbor points to be used. Both examples set nodata/NaN to -9999:

\begin{lstlisting}[language=bash]
idw="invdistnn:radius=2.0:max_points=50:min_points=1:nodata=-9999"
\end{lstlisting}
\item
  \emph{Interpolating to a grid.} We use the option
  \emph{GDAL\_NUM\_THREADS ALL\_CPUS} to use all available cores for the
  interpolation.

\begin{lstlisting}[language=bash]
gdal_grid --config GDAL_NUM_THREADS ALL_CPUS -of GTiff -co PREDICTOR=3 -co COMPRESS=DEFLATE -co ZLEVEL=7 -ot Float32 -txe $xmin $xmax -tye $ymin $ymax -zfield Z -a $linear -outsize $ncols $nrows -a_srs epsg:26911 Pozo_USGS_UTM11_NAD83_cat16_smrf_cl2.shp dtm_interp/Pozo_USGS_UTM11_NAD83_cat16_smrf_cl2_linear_1m.tif
\end{lstlisting}

  and

\begin{lstlisting}[language=bash]
gdal_grid -of GTiff -co PREDICTOR=3 -co COMPRESS=DEFLATE -co ZLEVEL=7 -ot Float32 -txe $xmin $xmax -tye $ymin $ymax -zfield Z -a $idw -outsize $ncols $nrows -a_srs epsg:26911 Pozo_USGS_UTM11_NAD83_cat16_smrf_cl2.shp dtm_interp/Pozo_USGS_UTM11_NAD83_cat16_smrf_cl2_idw_1m.tif
\end{lstlisting}
\item
  \emph{Clip and warp interpolated GeoTIFF.} The interpolation will
  result in border artifacts that will need to be clipped. We use the
  shapefile Pozo\_DTM\_noveg\_UTM11\_NAD83\_cat16.shp. Second, we
  inteprolate the grid to a 1m grid spacing and make sure that the grid
  is aligned with integer UTM coordinates \emph{-tap}.

\begin{lstlisting}[language=bash]
gdalwarp -tap -tr 1 1 -r bilinear --config GDAL_NUM_THREADS ALL_CPUS -co PREDICTOR=3 -co COMPRESS=DEFLATE -co ZLEVEL=7 -t_srs epsg:26911 -srcnodata -9999 -dstnodata -9999 -ot Float32 -crop_to_cutline -cutline Pozo_DTM_noveg_UTM11_NAD83_cat16.shp dtm_interp/Pozo_USGS_UTM11_NAD83_cat16_smrf_cl2_linear_1m.tif dtm_interp/Pozo_USGS_UTM11_NAD83_cat16_smrf_cl2_linear_1m_clip.tif
\end{lstlisting}

  and

\begin{lstlisting}[language=bash]
gdalwarp -tap -tr 1 1 -r bilinear --config GDAL_NUM_THREADS ALL_CPUS -co PREDICTOR=3 -co COMPRESS=DEFLATE -co ZLEVEL=7 -t_srs epsg:26911 -srcnodata -9999 -dstnodata -9999 -ot Float32 -crop_to_cutline -cutline Pozo_DTM_noveg_UTM11_NAD83_cat16.shp dtm_interp/Pozo_USGS_UTM11_NAD83_cat16_smrf_cl2_idw_1m.tif dtm_interp/Pozo_USGS_UTM11_NAD83_cat16_smrf_cl2_idw_1m_clip.tif
\end{lstlisting}
\end{enumerate}

The interpolated output tifs show differences: The IDW interpolation
provides the closest results to the \emph{blast2dem} approach,
especially in the steeper areas (Figure
\ref{Fig:Cat16_lasground_PDAL_diff}).

\begin{figure}
\centering
\includegraphics[width=\textwidth,height=0.9\textheight]{./tex2pdf.-e6884bf2dada0f3b/c1820159b77b07d3eb329d9de1686abfd1d6f527.png}
\caption{Map view of the PDAL DTM, generated from SMRF classification.
Middle row shows linearly interpolated ground-classified points and
bottom row shows IDW interpolation. Both grids have been compared to the
adjusted lasground grid that has been used as a comparison in Figure
\ref{Fig:Cat16_lasground_comparison}). See
\href{https://github.com/BodoBookhagen/PC_geomorph_roughness/blob/master/example_01/example01_create_DEM_PDAL_comparison_ground_classification_gmt.sh}{GMT
bash script} for generating this figure.
\label{Fig:Cat16_lasground_PDAL_diff}}
\end{figure}

\hypertarget{interpolation-to-a-grid-points2grid}{%
\subsection{Interpolation to a grid:
points2grid}\label{interpolation-to-a-grid-points2grid}}

This method is implemented by PDAL's
\href{https://pdal.io/stages/writers.gdal.html}{writers.gdal} approach.
\href{https://opentopography.org/otsoftware/points2grid}{Points2Grid}.
You can use the source code to run the interpolation to a grid from a
ground-classified PC from the command line with points2grid.

\hypertarget{classifying-ground-points-with-lidar2dem}{%
\subsection{Classifying ground points with
lidar2dem}\label{classifying-ground-points-with-lidar2dem}}

See \passthrough{\lstinline!l2d\_classify -h!}. Not implemented yet.

\hypertarget{point-cloud-pc-subsampling}{%
\section{Point Cloud (PC)
Subsampling}\label{point-cloud-pc-subsampling}}

Subsampling of PCs can be applied for some ground-classified PCs that
are very dense and noisy. In some cases, we may just want to get initial
results very fast - using fewer points will help to do that.

\hypertarget{pc-decimation-and-filtering-with-pdal}{%
\subsection{PC Decimation and filtering with
PDAL}\label{pc-decimation-and-filtering-with-pdal}}

PDAL provides some
\href{https://pdal.io/stages/filters.html\#cull}{culling} filters that
can be directly applied on the classified PC (or also on the raw,
unclassified PC). Most notably are
\href{https://pdal.io/stages/filters.sample.html\#filters-sample}{Poisson
Subsampling},
\href{https://pdal.io/stages/filters.decimation.html\#filters-decimation}{Decimation},
and
\href{https://pdal.io/stages/filters.voxelgrid.html\#filters-voxelgrid}{Voxelgrids}.

Applying a
\href{https://pdal.io/stages/filters.sample.html\#filters-sample}{Poisson
Subsampling} to the lasground-classified PC with a minimum distance
between the points of 0.25m can be achieved with the pipeline
\emph{example01\_Possion\_sampling.json}:

\begin{lstlisting}
{
  "pipeline":[
    {
        "type": "readers.las",
        "filename": "Pozo_USGS_UTM11_NAD83_cat16_clg_cl2.laz"
    },
    {
        "type":"filters.sample",
        "radius": 0.5
    },
    {
      "type":"writers.las",
      "filename":"Pozo_USGS_UTM11_NAD83_cat16_clg_cl2_radius50cm.las"
    }
  ]
}
\end{lstlisting}

Then run this with:

\begin{lstlisting}[language=bash]
pdal pipeline example01_Possion_sampling.json
\end{lstlisting}

The Poisson sub sampled (filtered) PC has been decimated, but the PC's
structure has been maintained (Figure
\ref{Fig:Cat16_PC_zoom_poisson_sampling}).

\begin{figure}
\centering
\includegraphics[width=\textwidth,height=0.9\textheight]{./tex2pdf.-e6884bf2dada0f3b/b7ead71189eb3082d8e107a64c92e4729469e718.png}
\caption{Oblique view of a subste of the lasground-classifed PC. Colors
are taken from draped airphoto. Top view shows original PC (ground-class
only), middle shows a Poisson radius of 10cm (minimum distance 10cm),
bottom shows a radius of 50cm.
\label{Fig:Cat16_PC_zoom_poisson_sampling}}
\end{figure}

Decimation can be carried out with the following pipeline
\emph{example01\_decimation\_sampling.json}:

\begin{lstlisting}
{
  "pipeline":[
    {
        "type": "readers.las",
        "filename": "Pozo_USGS_UTM11_NAD83_cat16_clg_cl2.laz"
    },
    {
        "type":"filters.decimation",
        "step": 10
    },
    {
      "type":"writers.las",
      "filename":"Pozo_USGS_UTM11_NAD83_cat16_clg_cl2_step10.las"
    }
  ]
}
\end{lstlisting}

Then run this with:

\begin{lstlisting}[language=bash]
pdal pipeline --nostream example01_Possion_sampling.json
\end{lstlisting}

\hypertarget{point-cloud-pc-geomorphologic-roughness-calculation-and-topographic-detrending}{%
\section{Point Cloud (PC) Geomorphologic roughness calculation and
topographic
detrending}\label{point-cloud-pc-geomorphologic-roughness-calculation-and-topographic-detrending}}

Detrending Point Cloud (PC) data with slope and calculating topographic
roughness and curvature from PCs.

The code reads in a ground-classified PC from a LAS/LAZ file and
calculates several geomorphology-relevant metrics on the PC. Input files
can be from a lidar or a Structure-from-Motion (SfM) PC, but should be
ground classified (for descriptions on how to ground-classify your data,
see previous sections). You may also want to subsample your point cloud
to generate a more homogenous point cloud. However, we provide a PC
density-based subsampling method that homogenizes the PC density by
either giving a fraction (or percentage) of points to be used (e.g.,
0.8) or the number of neighborhood points for 1m grid spacing.

The algorithm allows defining a radius which is used to fit a linear
plane through the point cloud to detrend the data (i.e., normalize the
point cloud with mean elevation of 0). These data are used to calculate
deviations from the mean (roughness) and identify rills, arroyos,
incised canyons, and other forms of erosion processes. By varying the
radius over which the plane is fitted, several scales of the landscape
can be analyzed (similar to varying radii of topographic relief). The
algorithm choses seed points from the PC with a user-defined spacing
(for example 1m) and calculated statistics for each seed point with that
given radius.

Output includes a set of shapefile and geotiffs that show statistics of
the PC within the given radius. Also, CSV and H5 files are created that
contain lists of seed point location and statistical results for further
analysis in Python or Matlab.

The code is parallized using \emph{multiprocess} and uses by default all
available cores. This significantly speeds up statistic calculation of
the point coud. For large point clouds, a significant amount of RAM is
required or you will need to split your point cloud into smaller tiles.

The code performs several additional steps that are described in detail
below. In summary, these are:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Finding seed points with a given spacing, usually 1m to 5m. The seed
  points are aligned to integer coordinates (e.g., UTM).
\item
  For each seed point and its neighborhood (for 1m spacing of seed
  points, points within a radius of 0.5m are used), statistics are
  calculated from the PC (and all points). These include, for example,
  slope, curvature, variability of height (Z) and slope-normalized Z
  values (for a full list and detailed description see below). The
  parameters also allow detrending the points within the seed-point
  radius by its slope and derive surface-roughness parameters not
  influenced by terrain slope.
\item
  Two algorithms included allows to subsample a point cloud either by a
  max. number of neighborhood points (e.g., k=5) or by defining a
  fraction of points to use to create a point cloud with approximately
  similar point-cloud density based on probabilities. The subsampled
  point cloud is written as a new LAS file. This step of point-cloud
  homogenization can also be performed by other approaches (see for
  example \href{https://pdal.io/stages/filters.html}{PDAL filters}.
  Especially, the filter
  \href{https://pdal.io/stages/filters.sample.html\#filters-sample}{Poisson
  Subsampling},
  \href{https://pdal.io/stages/filters.voxelcenternearestneighbor.html?highlight=voxel\%20centroid}{Voxelcenternearestneighbor},
  and
  \href{https://pdal.io/stages/filters.voxelcentroidnearestneighbor.html?highlight=voxel\%20centroid}{Voxelcentroidnearestneighbor}
  are interesting.
\item
  The code interpolates the seed points to a grid and writes the output
  as a geotiff. In addition, LAS files with seed points with relevant
  metrics are created.
\item
  If GMT is installed (and that opion has been selected when running
  from the command line), a set of output maps is generated for initial
  visualization.
\end{enumerate}

\hypertarget{input-parameters-and-options}{%
\subsection{Input Parameters and
options}\label{input-parameters-and-options}}

\emph{NOTE: pc\_geomorph\_roughness relies on a PC containing only
ground points. }

Before running, make sure the proper environment is activated:

\begin{lstlisting}[language=bash]
source activate PC_py3
\end{lstlisting}

List of argument is obtained by

\begin{lstlisting}[language=bash]
python ~/PC_geomorph_roughness/pc_geomorph_roughness.py
\end{lstlisting}

and an extended help for each parameters is obtained by

\begin{lstlisting}[language=bash]
python ~/PC_geomorph_roughness/pc_geomorph_roughness.py -h
\end{lstlisting}

With explanation of input parameters in:

\begin{lstlisting}
usage: pc_geomorph_roughness.py [-h] -i INLAS [--raster_m RASTER_M]
                                [--raster_m_range RASTER_M_RANGE]
                                [--subsample_1m_pc_k SUBSAMPLE_1M_PC_K]
                                [--subsample_1m_pc_p SUBSAMPLE_1M_PC_P]
                                [--redo_subsample_1m_pc_p REDO_SUBSAMPLE_1M_PC_P]
                                [--k_nr_of_neighbors K_NR_OF_NEIGHBORS]
                                [--dem_fname DEM_FNAME]
                                [--shapefile_clip SHAPEFILE_CLIP]
                                [--epsg_code EPSG_CODE]
                                [--create_shapefiles CREATE_SHAPEFILES]
                                [--create_geotiff CREATE_GEOTIFF]
                                [--create_gmt CREATE_GMT]
                                [--create_las CREATE_LAS]
                                [--mean_z_only MEAN_Z_ONLY]
                                [--nr_of_cores NR_OF_CORES]
                                [--max_nr_of_neighbors_kdtree MAX_NR_OF_NEIGHBORS_KDTREE]
                                [--pt_lower_threshold PT_LOWER_THRESHOLD]
                                [--create_gmt_maps CREATE_GMT_MAPS]
                                [--gmt_title GMT_TITLE]
                                [--gmt_basename GMT_BASENAME]
                                [--plot_plane_fits PLOT_PLANE_FITS]
                                [--plot_plane_fits_nr_points PLOT_PLANE_FITS_NR_POINTS]
                                [--ransac_on RANSAC_ON]

PointCloud (PC) processing for DEM statistics. Deriving gridded ground data
(elevation and slope) using centroid coordinates. B. Bookhagen
(bodo.bookhagen@uni-potsdam.de), V0.2 Dec 2018.

optional arguments:
  -h, --help            show this help message and exit
  -i INLAS, --inlas INLAS
                        LAS/LAZ file with point-cloud data. This file must
                        only contain ground points (class == 2)
  --raster_m RASTER_M   Raster spacing or diameter for subsampling seed points
                        on LAS/LAZ PC. Usually 0.5 to 10 m, default = 1. Seed
                        points are selected from radii half this diameter.
  --raster_m_range RASTER_M_RANGE
                        Raster spacing for subsampling seed points on LAS/LAZ
                        PC. Uses a list of ranges with spacing, e.g.,
                        --raster_m_range "1 10 1" will create raster files
                        with spatial resolutions of 1 to 10 m in 1 m steps.
  --subsample_1m_pc_k SUBSAMPLE_1M_PC_K
                        Number of points in radius=0.5m that are randomly
                        subsampled from the full point cloud. This is useful
                        if point-cloud density greatly varies, because
                        statistics calculated for seed points with different
                        point numbers may be biased. If subsample_pc_k > 0
                        then the point cloud will be homogenized by selecting
                        k=n neighbors for each 1-m seed point. For example, if
                        subsample_pc_k 10, then each 1m seed point will have
                        only 10 neighbors. Subsampled point cloud is written
                        to LAS file.
  --subsample_1m_pc_p SUBSAMPLE_1M_PC_P
                        Factor to subsample point cloud based on probability.
                        If --subsample_1m_pc_p 0.8, a point cloud with 80% of
                        the input points is generated and sampling of point
                        cloud is based on density probability. That is,
                        neighboring points for a seed point with a high number
                        of neighbors a sampled less often, than a seed point
                        with fewer neighbors. Will use original points, but
                        creates a reduced point cloud. Calculates probability
                        from 1m seed-point spacing. Subsampled point cloud is
                        written to LAS file.
  --redo_subsample_1m_pc_p REDO_SUBSAMPLE_1M_PC_P
                        Flag to redo random subsampling based on probability.
                        By default, an existing file with a probability is
                        loaded, if you set "--redo_subsample_1m_pc_p true",
                        the random subsampling based on probability will be
                        rerun and stored in a separate LAS file.
  --k_nr_of_neighbors K_NR_OF_NEIGHBORS
                        Number of neighbors for dynamic density estimation
                        (k_nr_of_neighbors = 50 by default). Change to lower
                        number for lower-density point clouds to increase
                        procesing speed. For SfM PCs this should be set to 100
                        or higher.
  --dem_fname DEM_FNAME
                        Filename of DEM to extract point spacing. Used to
                        identify seed-point coordinates. Useful if a DEM
                        exists and one wants to create point-cloud statistics
                        aligned to the DEM grid.
  --shapefile_clip SHAPEFILE_CLIP
                        Name of shapefile to be used to clip interpolated
                        surfaces. Make sure to give full pathname. This is
                        likely the shapefile that has been previously
                        generated to subset/clip the point-cloud data.
  --epsg_code EPSG_CODE
                        EPSG code (integer) to define projection information.
                        This should be the same EPSG code as the input LAS
                        data (no re-projection is included in this code yet)
                        and can be taken from LAS/LAZ input file. Add this to
                        ensure that output shapefile and GeoTIFFs are properly
                        geocoded.
  --create_shapefiles CREATE_SHAPEFILES
                        Create point shapefiles in UTM (see --epsg_code) and
                        Geographic-DD projection. These contain all attributes
                        calculated during the processing (default no
                        shapefiles are created: --create_shapefiles 0, set to
                        --create_shapefiles 1 to generate shapefiles).
  --create_geotiff CREATE_GEOTIFF
                        Create interpolated geotif files from PC data (default
                        no: --create_geotiff 0, set to --create_geotiff 1 to
                        generate geotiff files). Note that creating geotiff
                        files may increase processing time
  --create_gmt CREATE_GMT
                        Create gmt point or vector files for plotting with GMT
                        shapefiles in UTM (see --epsg_code) and Geographic-DD
                        projection. These contain all attributes calculated
                        during the processing (default no: --create_gmt 0, set
                        to --create_gmt 1 to generate GMT files).
  --create_las CREATE_LAS
                        Create LAS point file from seed points. The color
                        shows mean elevation of the seed points (default no:
                        --create_las 0, set to --create_las 1 to generate LAS
                        files).
  --mean_z_only MEAN_Z_ONLY
                        Calculate mean elevation for grid cell size and no
                        other parameters.
  --nr_of_cores NR_OF_CORES
                        Max. number of cores to use for multi-core processing.
                        Default is to use all cores (--nr_of_cores 0), set to
                        --nr_of_cores 6 to use 6 cores. For some memory-
                        intensive applications, it may be useful to reduce the
                        number of cores.
  --max_nr_of_neighbors_kdtree MAX_NR_OF_NEIGHBORS_KDTREE
                        Setting the max. number of neighbors for KDTree
                        search. This can remain at 100 points for airborne
                        lidar data. For example, if you have a point density
                        of 5 pts/m2, 100 pts are 20 m2. You may want to
                        consider increasing this when using terrestrial lidar
                        data, SfM data, or airborne data with high point
                        densities.
  --pt_lower_threshold PT_LOWER_THRESHOLD
                        Minimum number of points for performing plane fitting
                        and slope normalization (lower point threshold). If
                        there are less than pt_lower_threshold in the seed-
                        point neighborhood (default --pt_lower_threshold 3), a
                        point fitting is not performed and values are set to
                        NaN.
  --create_gmt_maps CREATE_GMT_MAPS
                        BASH File with GMT commands for plotting maps. Full
                        path and filename is required. Will need to be fine
                        tuned (see example).
  --gmt_title GMT_TITLE
                        GMT title to appear in output map.
  --gmt_basename GMT_BASENAME
                        GMT basename for Postscript filenames.
  --plot_plane_fits PLOT_PLANE_FITS
                        Create plots of plane fits for individual seed points
                        with more than plot_plane_fits_nr_points (default =
                        10) neighborhood points in subdirectory "maps". Mostly
                        for testing purposes, default is off
                        (--plot_plane_fits 0).
  --plot_plane_fits_nr_points PLOT_PLANE_FITS_NR_POINTS
                        Set number of neighborhood points to create plot for
                        seed point. Default is --plot_plane_fits_nr_points 10.
                        You will need to adjust this for larger neighborhood
                        radii.
  --ransac_on RANSAC_ON
                        Turn RANSAC fitting on. This will significantly
                        increase the processing time, but will give better and
                        tighter fits.
\end{lstlisting}

\hypertarget{output-files}{%
\subsection{Output Files}\label{output-files}}

The folder \emph{HDF} contains all results in HDF format. The same
results are also stored in CSV format. Both can be readily loaded by
post-processing software (Python, Matlab, R). The following fields are
stored:

\begin{itemize}
\tightlist
\item
  \emph{1SeedX, 2SeedY, 3SeedZ}: contain the seed-point location (this
  is a real point in the PC)
\item
  \emph{4MeanX, 5MeanY, 6MeanZ}: contain the average of all X, Y, Z
  points for the seed point calculated by taking the average of each
  coordinate. This results in an interpolated point
\item
  \emph{7Z\_min, 8Z\_max}: minimum and maximum Z (height) for this seed
  point
\item
  \emph{9Dz\_max, 10Dz\_min, 11Dz\_std}: values are obtained from
  slope-normalized points. All points within a seed-point radius were
  normalized by their slope (i.e., a fitted plane has been subtracted
  from all points and their mean elevation is now 0). These fields
  contain maximum, minimum, and standard deviation of the normalized PC.
\item
  \emph{12Dz\_range, 13Dz\_9010p, 14Dz\_7525p, 15Dz\_var}: Additional
  metrics derived from the slope-normalized PC: range (max. - min.),
  90th minus 10th percentile, 75th minus 25 th percentile (IQR:
  InterQuartileRange), variance
\item
  \emph{16Slp\_p1}: Linear (polynomial order=1) least-squared fit
\item
  \emph{17Slp\_p1r}: RMSE in meter from linear (polynomial order=1)
  least-squared fit
\item
  \emph{18Slp\_p2}: Second order polynomial (polynomial order=2)
  least-squared fit
\item
  \emph{19Slp\_p2r}: RMSE in meter of second-order polynomial
  (polynomial order=2) least-squared fit
\item
  \emph{20Nr\_lidar}: number of lidar points in the seed-point
  neighborhood, will increase with larger radii.
\item
  \emph{21CC\_p2, 22CT\_p2, 23CP\_p2}: Contour Curvature, tangential
  Curvature, and profile Curvature derived from fitting the second-order
  polynom.
\item
  \emph{24CC\_p4, 25CT\_p4, 26CP\_p4}: Contour Curvature, tangential
  Curvature, and profile Curvature derived from fitting the fourth-order
  polynom.
\item
  \emph{27C\_p4r}: RMSE in meter of fourth-order polynomial (polynomial
  order=4) least-squared fit
\item
  \emph{28StdZ}: Standard deviation of elevations in seed-point
  neighborhood (not slope-normalized).
\end{itemize}

\hypertarget{geotiff-files}{%
\subsubsection{GeoTIFF files}\label{geotiff-files}}

There are several interpolated results onto equally-spaced grids in the
\emph{geotiff} folder. These can be used for visualization in QGIS or
GMT. See map outputs below REFERENCE.

\hypertarget{las-files}{%
\subsubsection{LAS files}\label{las-files}}

The results of the seed-point analysis are also written to las files
(\emph{LAS} directory). These are colored by their respective variables
(Figure \ref{Fig:Cat16_PC_zoom_Z_slope_IQR_results}). Currently, the
following parameters are created and colored by different colormaps:

\begin{itemize}
\tightlist
\item
  *\_xyzmean.las: Mean position of X, Y, Z seed points, colored by
  elevation
\item
  *\_iqrdZ.las: IQR of normalized elevation (roughness indicator)
\item
  *\_slope\_p1\_lstsq.las: Linear (polynomial order = 1) least-square
  fits of planar slope
\item
  *\_slope\_p2\_lstsq.las: Second order (polynomial order = 2)
  least-square fits of planar slope
\item
  *\_radius\_mean\_curv.las: Second order (polynomial order = 2)
  least-square fits of curvature
\end{itemize}

\hypertarget{examples}{%
\section{Examples}\label{examples}}

In the following three sections, we provide detailed step-by-step
explanation of the processing with \emph{PC\_geomorph\_roughness}. There
are GMT scripts included that generate output maps. We focus on three
sub-catchments in the SW part of Santa Cruz Island (Pozo catchment)
\ref{Fig:Pozo_DEM_examples_map}. All data are available through
\href{https://opentopography.org/}{OpenTopography}, but a subset of the
data is provided in the respective subdirectories.

\begin{figure}
\centering
\includegraphics{./tex2pdf.-e6884bf2dada0f3b/e4cf5bec248640a8b4788714fe207e3bea984b91.png}
\caption{Topographic overview map of the southwestern part of Santa Cruz
Island (Pozo catchment). The four example catchments discussed are
outlined by polygons (see
\href{https://github.com/BodoBookhagen/PC_geomorph_roughness/blob/master/example_01/plot_GMT_Pozo_4catchments_overview.sh}{GMT
bash script}) for creating this map.\label{Fig:Pozo_DEM_examples_map}}
\end{figure}

\hypertarget{example-01---subcatchment-of-the-sw-area-of-pozo-on-sci}{%
\subsection{Example 01 - subcatchment of the SW area of Pozo on
SCI}\label{example-01---subcatchment-of-the-sw-area-of-pozo-on-sci}}

In order to show how \emph{PC\_geomorph\_roughness} works, we show the
usuall steps done to process a catchment.

\emph{NOTE: If you re-run PC\_geomorph\_roughness with different
options, make sure to remove the directories or files containing the
data. By default, PC\_geomorph\_roughness will load existing HDF5 and
geotiff files. For example, use rm -fr hdf/ geotiff/ LAS/ pickle/ }

\hypertarget{summary-of-pre-processing-steps-to-create-a-classified-point-cloud}{%
\subsubsection{Summary of pre-processing steps to create a classified
point
cloud}\label{summary-of-pre-processing-steps-to-create-a-classified-point-cloud}}

In order to generate a ground-classified point cloud, we use the
following script and approach:

\begin{lstlisting}[language=bash]
cd example_01
pdal translate Pozo_USGS_UTM11_NAD83_cat16.laz Pozo_USGS_UTM11_NAD83_cat16_SMRF_cl2.las --json example01_PDAL_SMRF_pipeline.json
\end{lstlisting}

Next, generate a DTM from the ground-classified PC:

\begin{lstlisting}[language=bash]
mkdir dtm_interp
pdal pipeline --nostream example01_writers_gdal_smrf_Zmean_1m.json
\end{lstlisting}

\hypertarget{first-steps-random-subsampling}{%
\subsubsection{First steps: random
subsampling}\label{first-steps-random-subsampling}}

Following steps are necessary to process the SMRF-classified PC
(\emph{-i Pozo\_USGS\_UTM11\_NAD83\_cat16\_ SMRF\_cl2.las}) with
smoothing ranging from 1 to 10 m in steps of 1 m
(\emph{--raster\_m\_range \enquote{1 10 1}}), clipping the interpolated
surface with a shapefile outlining the catchment
(\emph{--shapefile\_clip Pozo\_DTM\_noveg\_UTM11\_NAD83\_cat16.shp}),
assigning the proper EPSG code to the output GeoTIFF file
(\emph{--epsg\_code 26911}), using all available cores for statistical
calculation (\emph{--nr\_of\_cores 0}), creating output GeoTIFF files
(\emph{--create\_geotiff 1}), not creating GMT masp (\emph{--create\_gmt
0}), not creating shapefiles (\emph{--create\_shapefiles 0}), but
creating a LAS file with mean elevation (\emph{--create\_las 1}), and
subsampling the pointcloud with k=10 neighbors
(\emph{--subsample\_1m\_pc\_k 10}). In order to keep track of the
output, we pipe the text output to a log file. Because some python numpy
operations may produce warnings (for example, if there are not enough
points in a grid cell), we turn off these warnings with \emph{-W
ignore}:

\begin{lstlisting}[language=bash]
python -W ignore ~/Dropbox/soft/github/PC_geomorph_roughness/pc_geomorph_roughness.py \
    -i Pozo_USGS_UTM11_NAD83_cat16_SMRF_cl2.las \
    --raster_m_range "1 10 1" \
    --shapefile_clip Pozo_DTM_noveg_UTM11_NAD83_cat16.shp \
    --epsg_code 26911 --nr_of_cores 0 --create_geotiff 1 --create_gmt 0  \
    --create_shapefiles 0 --create_las 1 \
    --subsample_1m_pc_k 10 \
    2>&1 | tee Pozo_USGS_UTM11_NAD83_cat16_SMRF_cl2_pc_geomorph_roughness_subsample_k10_1_10_1.log
\end{lstlisting}

Use displaz to view the randomly subsampled point cloud with k=5
neighbors (displaz Pozo\_USGS\_UTM11\_
NAD83\_cat16\_SMRF\_cl2\_randomsubsampled\_k10.las). The directory
\emph{LAS} contains the seed-point outputs at the requested spacings:
The file \emph{LAS/
Pozo\_USGS\_UTM11\_NAD83\_cat16\_SMRF\_cl2\_seed\_pts\_1.00m\_
radius\_xyzmean.las} contains seed-point spacing of 1m and the mean X,
Y, Z values in color. Interesting LAS files to explore are, for example,
\emph{LAS/Pozo\_USGS\_UTM11\_NAD83\_cat16\_SMRF\_cl2\_seed\_pts\_2.00m\_
radius\_slope\_p1\_lstsq.las} that show the least-squared fit of the
slope derived from all points in a 2m neighborhood (r=1m).

We investigate the mean height, least-squared slope and IQR of
normalized elevation in the LAS directory (Figures
\ref{Fig:Cat16_PC_zoom_Z_slope_IQR_results} and
\ref{Fig:Cat16_PC_zoom_Z_slope_IQR_results_2nd}):

\begin{itemize}
\tightlist
\item
  \emph{Pozo\_USGS\_UTM11\_NAD83\_cat16\_SMRF\_cl2\_seed\_pts\_1.00m\_radius\_xyzmean.las}
\item
  \emph{Pozo\_USGS\_UTM11\_NAD83\_cat16\_SMRF\_cl2\_seed\_pts\_1.00m\_radius\_slope\_p1\_lstsq.las}
\item
  \emph{Pozo\_USGS\_UTM11\_NAD83\_cat16\_SMRF\_cl2\_seed\_pts\_1.00m\_radius\_slope\_p2\_lstsq.las}
\item
  \emph{Pozo\_USGS\_UTM11\_NAD83\_cat16\_SMRF\_cl2\_seed\_pts\_1.00m\_radius\_iqrdZ.las}
\end{itemize}

\begin{figure}
\centering
\includegraphics[width=\textwidth,height=0.9\textheight]{./tex2pdf.-e6884bf2dada0f3b/6aedeb92c55ca2f9969ecdcbbd599856016ed156.png}
\caption{Oblique view of a PC showing mean elevation for each seed point
(top left), least-squared slope (top right), IQR of normalized elevation
(bottom left), and curvature (bottom right).
\label{Fig:Cat16_PC_zoom_Z_slope_IQR_results}}
\end{figure}

\begin{figure}
\centering
\includegraphics[width=\textwidth,height=0.9\textheight]{./tex2pdf.-e6884bf2dada0f3b/ff9bfc192bd7ecb5cc3c0bfc48bbf888f299e147.png}
\caption{Alternative oblique view of a PC showing mean elevation for
each seed point (top left), IQR of normalized elevation (top right),
least-squared linear (polynom order=1) slope (bottom left),
least-squared linear (polynom order=2) slope (bottom right).
\label{Fig:Cat16_PC_zoom_Z_slope_IQR_results_2nd}}
\end{figure}

\hypertarget{what-polynomial-fit-is-most-appropriate}{%
\subsubsection{What polynomial fit is most
appropriate?}\label{what-polynomial-fit-is-most-appropriate}}

The code fits a polynom to all points in the neighborhood. It uses a
least-squared approach to reduce the impact of outliers. For polynom
order=1 (planar fit), the results are shown as a point cloud in Figure
\ref{Fig:Cat16_PC_zoom_Z_slope_IQR_results_2nd}-bottom left. We can
compare the fits for some example point. In most cases, the
least-squared planar (order=1) fit for slope determination works just
fine (see Figures \ref{Fig:PlaneFit_seed00020901} to
\ref{Fig:PlaneFit_seed00020319}. The curvature calculation is based on
the mean curvature of the second-order polynom.

\begin{figure}
\centering
\includegraphics[width=\textwidth,height=0.9\textheight]{./tex2pdf.-e6884bf2dada0f3b/b096a2b8e56eebc80f4b8556f702600ef12f3085.png}
\caption{Characteristic example where planar (order=1) fit in black
colors is very close to a polynomial fit with order=2 in blue color.
Orginial points are blue dots. Right plot shows normalized point heights
and their distances: black dots are distances for the planar fit, blue
points for the polynomial order=2 fit.\label{Fig:PlaneFit_seed00020901}}
\end{figure}

\begin{figure}
\centering
\includegraphics[width=\textwidth,height=0.9\textheight]{./tex2pdf.-e6884bf2dada0f3b/acbc77d9932d9a3aa0ebe41a783a59e2cb53bbe3.png}
\caption{Characteristic example where planar (order=1) fit in black
colors is very close to a polynomial fit with order=2 in blue color.
Orginial points are blue dots. Right plot shows normalized point heights
and their distances: black dots are distances for the planar fit, blue
points for the polynomial order=2 fit.\label{Fig:PlaneFit_seed00020326}}
\end{figure}

\begin{figure}
\centering
\includegraphics[width=\textwidth,height=0.9\textheight]{./tex2pdf.-e6884bf2dada0f3b/060d9cb1751811d975677e7d1c8025b5f6fe3b25.png}
\caption{Characteristic example where planar (order=1) fit in black
colors is different to a polynomial fit with order=2 in blue color.
Orginial points are blue dots. Right plot shows normalized point heights
and their distances: black dots are distances for the planar fit, blue
points for the polynomial order=2 fit.\label{Fig:PlaneFit_seed00020319}}
\end{figure}

\begin{figure}
\centering
\includegraphics[width=\textwidth,height=0.9\textheight]{./tex2pdf.-e6884bf2dada0f3b/b096a2b8e56eebc80f4b8556f702600ef12f3085.png}
\caption{Characteristic example where planar (order=1) fit in black
colors is very close to a polynomial fit with order=2 in blue color.
Orginial points are blue dots. Right plot shows normalized point heights
and their distances: black dots are distances for the planar fit, blue
points for the polynomial order=2 fit.\label{Fig:PlaneFit_seed00020901}}
\end{figure}

\hypertarget{next-steps-density-based-subsampling}{%
\subsubsection{Next steps: density-based
subsampling}\label{next-steps-density-based-subsampling}}

\emph{NOTE: If you re-run PC\_geomorph\_roughness with different
options, make sure to remove the directories or files containing the
data. By default, PC\_geomorph\_roughness will load existing HDF5 and
geotiff files. Save or move your results to a different folder and
remove folders. For example, do a \textbf{rm -fr hdf/ geotiff/ LAS/
pickle/} }

In addition to the above example, we now subsample the pointcloud to
80\% of the original points by PC density. Note the option
\emph{--subsample\_1m\_pc\_p 0.8}.

\begin{lstlisting}[language=bash]
python -W ignore ~/Dropbox/soft/github/PC_geomorph_roughness/pc_geomorph_roughness.py \
    -i Pozo_USGS_UTM11_NAD83_cat16_SMRF_cl2.las \
    --raster_m_range "1 10 1" \
    --shapefile_clip Pozo_DTM_noveg_UTM11_NAD83_cat16.shp \
    --epsg_code 26911 --nr_of_cores 0 --create_geotiff 1 --create_gmt 0  \
    --create_shapefiles 0 --create_las 1 \
    --subsample_1m_pc_p 0.8 \
    2>&1 | tee Pozo_USGS_UTM11_NAD83_cat16_SMRF_cl2_pc_geomorph_roughness_subsample_p08_1_10_1.log
\end{lstlisting}

\hypertarget{next-steps-density-based-subsampling-and-gmt-map-generation}{%
\subsubsection{Next steps: density-based subsampling and GMT map
generation}\label{next-steps-density-based-subsampling-and-gmt-map-generation}}

In addition to the above example, we now subsample the pointcloud to
80\% of the original points by PC density and we generate GMT output
files. Note the options \emph{--create\_gmt\_maps}, \emph{--gmt\_title},
and \emph{--gmt\_basename}.

Before maps can be generate with GMT, the GMT script will need to be
edited. See
\emph{PC\_geomorph\_roughness/NEED\_TO\_EDIT\_create\_map\_view\_of\_PC\_geomorph\_output\_gmt.sh}
as a starting point. For the directory example\_01, we include a GMT
script that will generate a useful set of maps (see
\emph{example\_01/example01\_create\_map\_view\_of\_PC\_geomorph\_output\_gmt.sh}).
The script is a bash script that calls GMT to generate several maps. you
will need to set scale and other parameters for your catchment.

\emph{NOTE: Make sure to give the full path to the Shapefile used as
clip and for the GMT Shell script!}

\begin{lstlisting}[language=bash]
python -W ignore ~/github/PC_geomorph_roughness/\
PC_geomorph_roughness/pc_geomorph_roughness.py \
    -i Pozo_USGS_UTM11_NAD83_cat16_SMRF_cl2.las \
    --raster_m_range "1 10 1" \
    --shapefile_clip ~/github/PC_geomorph_roughness/\
example_01/Pozo_DTM_noveg_UTM11_NAD83_cat16.shp \
    --epsg_code 26911 --nr_of_cores 0 --create_geotiff 1 --create_gmt 0  \
    --create_shapefiles 0 --create_las 1 \
    --subsample_1m_pc_p 0.8 \
    --create_gmt_maps ~/github/PC_geomorph_roughness/\
example_01/example01_create_map_view_of_PC_geomorph_output_gmt.sh \
    --gmt_title "Ex01 in Pozo" \
    --gmt_basename "Example01_cl2" \
    2>&1 | tee Pozo_USGS_UTM11_NAD83_cat16_SMRF_cl2_pc_geomorph_roughness_subsample_p08_1_10_1.log
\end{lstlisting}

This will generate a set of output maps with GMT that are illustrated
below (Figures \ref{Fig:Ex01_cl2_1.0m_2panel_DEMs},
\ref{Fig:Ex01_cl2_1.0m_2panel_SLPs},
\ref{Fig:Ex01_cl2_1.0m_2panel_NRLIDARPTS_DZ_STDDEV},
\ref{Fig:Ex01_cl2_1.0m_2panel_DZ9010P_IQR},
\ref{Fig:Ex01_cl2_1.0m_2panel_RMSE}, \ref{Fig:NrLidarPots_1_2_3_5m},
\ref{Fig:SMRF_slopeP1_1_2_3_5m},
\ref{Fig:SMRF_slopeP2_1_2_3_5m},\ref{Fig:dz_IQR_1_2_3_5m},
\ref{Fig:SMRF_RMSE_P1_1_2_3_5m}, \ref{Fig:SMRF_RMSE_P2_1_2_3_5m}).

\begin{figure}
\centering
\includegraphics[width=\textwidth,height=0.9\textheight]{./tex2pdf.-e6884bf2dada0f3b/d939b9bb2bf4c38cf01849d92eb998542f7c8258.png}
\caption{Output of 1m DEM generated from the interpolated point cloud
and difference DEM between the mean seed height and the interpolated
DEM. Note that the interpolated DEM is based on all ground points, while
the mean-seed point DEM used the largely reduced seed point
PC.\label{Fig:Ex01_cl2_1.0m_2panel_DEMs}}
\end{figure}

\begin{figure}
\centering
\includegraphics[width=\textwidth,height=0.9\textheight]{./tex2pdf.-e6884bf2dada0f3b/73fad069247dad484605fc537461f949b78368ca.png}
\caption{Output of the slope values derived for each seed points and
using the seed-point neighbors. The second-order polynomial fit usually
provides more realist results for natural (steep) terrain. Note that for
some areas, slopes are steep because of few points leading to low fit
quality (large residual, cf \ref{Fig:Ex01_cl2_1.0m_2panel_RMSE}).
\label{Fig:Ex01_cl2_1.0m_2panel_SLPs}}
\end{figure}

\begin{figure}
\centering
\includegraphics[width=\textwidth,height=0.9\textheight]{./tex2pdf.-e6884bf2dada0f3b/04ead4fa949555f67585055846aea76f7764f0d7.png}
\caption{Output of number of points for seed-point neighborhood and the
standard deviation of normalized points (normalized by slopes). The
higher the standard deviation, the more rough the terrain.
\label{Fig:Ex01_cl2_1.0m_2panel_NRLIDARPTS_DZ_STDDEV}}
\end{figure}

\begin{figure}
\centering
\includegraphics[width=\textwidth,height=0.9\textheight]{./tex2pdf.-e6884bf2dada0f3b/835f403ed54a91212c9828260d87dcc7bc64d68c.png}
\caption{Results from slope-normalized roughness calculations: 90th
minus 10th percentile and inter-quartil range (IQR: 75th-25th
percentile) \label{Fig:Ex01_cl2_1.0m_2panel_DZ9010P_IQR}}
\end{figure}

\begin{figure}
\centering
\includegraphics[width=\textwidth,height=0.9\textheight]{./tex2pdf.-e6884bf2dada0f3b/5ca5cbbd3a006a2939910b7f6d9a4fef85b388a3.png}
\caption{RMSE (in meter) from the first and second order polynomial
fitting. \label{Fig:Ex01_cl2_1.0m_2panel_RMSE}}
\end{figure}

\begin{figure}
\centering
\includegraphics[width=\textwidth,height=0.9\textheight]{./tex2pdf.-e6884bf2dada0f3b/bcffdba67d4cc0711acb388e0a0030b437927784.png}
\caption{Number of points in analysis radii increase rapidly and will
lead to more robust results. Here, the number of neighborhood points for
1, 2, 3, and 5 m of interpolation diameters are shown. Note the
different ranges of the colorscale \label{Fig:NrLidarPots_1_2_3_5m}}
\end{figure}

\begin{figure}
\centering
\includegraphics[width=\textwidth,height=0.9\textheight]{./tex2pdf.-e6884bf2dada0f3b/1a463bce6607f26dd4a76a72c47365177c0af0fd.png}
\caption{Deriving slopes for large neighborhood of points results in
more realistic slope values. Here, the slopes for diameters of 1, 2, 3,
and 5 m are shown. We only show the planar (polynomial order=1) slopes.
\label{Fig:SMRF_slopeP1_1_2_3_5m}}
\end{figure}

\begin{figure}
\centering
\includegraphics[width=\textwidth,height=0.9\textheight]{./tex2pdf.-e6884bf2dada0f3b/30f0466a84ddcdc69609961bea73d7c5d751682f.png}
\caption{Deriving slopes for large neighborhood of points results in
more realistic slope values. Here, the slopes for diameters of 1, 2, 3,
and 5 m are shown. We only show the second order polynoms (polynomial
order=2) slopes. These have generally a lower RMSE than polynomial
orders=1. \label{Fig:SMRF_slopeP2_1_2_3_5m}}
\end{figure}

\begin{figure}
\centering
\includegraphics[width=\textwidth,height=0.9\textheight]{./tex2pdf.-e6884bf2dada0f3b/60a2504196ffb0c6844e21ac20c6cb5f3aaa7710.png}
\caption{The IQR reflects channels and arroyos with increasing
interpolation radii. Here, the slope-normalized elevation (IQR) for 1,
2, 3, and 5 m of interpolation diameters are shown.
\label{Fig:dz_IQR_1_2_3_5m}}
\end{figure}

\begin{figure}
\centering
\includegraphics[width=\textwidth,height=0.9\textheight]{./tex2pdf.-e6884bf2dada0f3b/bd561534a3dbf4451b3a6d20fd118a224e5bb1f7.png}
\caption{RMSE (m) from linear fits (polynomial order = 1) for radii 1,
2, 3, and 5 m are shown. \label{Fig:SMRF_RMSE_P1_1_2_3_5m}}
\end{figure}

\begin{figure}
\centering
\includegraphics[width=\textwidth,height=0.9\textheight]{./tex2pdf.-e6884bf2dada0f3b/6c1005ea0648fc15eceed92b7c39185b225a737e.png}
\caption{RMSE (m) from linear fits (polynomial order = 2) for radii 1,
2, 3, and 5 m are shown. \label{Fig:SMRF_RMSE_P2_1_2_3_5m}}
\end{figure}

\hypertarget{analysis-of-the-lasground-classified-pc}{%
\subsubsection{Analysis of the lasground classified
PC}\label{analysis-of-the-lasground-classified-pc}}

In a separate approach, we have used the lasground-classified PC to
illustrate the differences for the PDAL-SMRF classifed PC. This file is
also provided on the github page
(\href{https://github.com/BodoBookhagen/PC_geomorph_roughness/blob/master/example_01/Pozo_USGS_UTM11_NAD83_cat16_clg_cl2.laz}{example\_01/Pozo\_USGS\_UTM11\_NAD83\_cat16\_clg\_cl2.laz}).

We first save previous results:

\begin{lstlisting}[language=bash]
mv geotiff geotiff_PDAL_SMRF
mv LAS LAS_PDAL_SMRF
mv vrt  vrt_PDAL_SMRF 
mv hdf hdf_PDAL_SMRF
\end{lstlisting}

Then we run \emph{PC\_geomorph\_roughness} for the lasground-classified
PC:

\begin{lstlisting}[language=bash]
python -W ignore ~/github/PC_geomorph_roughness/\
PC_geomorph_roughness/pc_geomorph_roughness.py \
    -i Pozo_USGS_UTM11_NAD83_cat16_clg_cl2.laz \
    --raster_m_range "1 10 1" \
    --shapefile_clip ~/github/PC_geomorph_roughness/\
example_01/Pozo_DTM_noveg_UTM11_NAD83_cat16.shp \
    --epsg_code 26911 --nr_of_cores 0 --create_geotiff 1 --create_gmt 0  \
    --create_shapefiles 0 --create_las 1 \
    --subsample_1m_pc_p 0.8 \
    --create_gmt_maps ~/github/PC_geomorph_roughness/\
example_01/example01_create_map_view_of_PC_geomorph_output_gmt.sh \
    --gmt_title "Ex01 in Pozo" \
    --gmt_basename "Example01_cl2" \
    2>&1 | tee Pozo_USGS_UTM11_NAD83_cat16_lasground_cl2_pc_geomorph_roughness_subsample_p08_1_10_1.log
\end{lstlisting}

The results are similar to the PDAL-SMRF classified PC (Figures
\ref{Fig:lasground_slopeP1_1_2_3_5m},
\ref{Fig:lasground_slopeP2_1_2_3_5m},
\ref{Fig:lasground_dz_IQR_1_2_3_5m},
\ref{Fig:lasground_RMSE_P1_1_2_3_5m}, and
\ref{Fig:lasground_RMSE_P2_1_2_3_5m}).

\begin{figure}
\centering
\includegraphics[width=\textwidth,height=0.9\textheight]{./tex2pdf.-e6884bf2dada0f3b/4e7d90284af8681a20f87d6c30d94d723c0d4fa3.png}
\caption{Deriving slopes for large neighborhood of points results in
more realistic slope values. Here, the slopes for diameters of 1, 2, 3,
and 5 m are shown. We only show the planar (polynomial order=1) slopes.
\label{Fig:lasground_slopeP1_1_2_3_5m}}
\end{figure}

\begin{figure}
\centering
\includegraphics[width=\textwidth,height=0.9\textheight]{./tex2pdf.-e6884bf2dada0f3b/e21d6ee294348cce3bd17e5e3e4943b918eac98f.png}
\caption{Deriving slopes for large neighborhood of points results in
more realistic slope values. Here, the slopes for diameters of 1, 2, 3,
and 5 m are shown. We only show the second order polynoms (polynomial
order=2) slopes. These have generally a lower RMSE than polynomial
orders=1. \label{Fig:lasground_slopeP2_1_2_3_5m}}
\end{figure}

\begin{figure}
\centering
\includegraphics[width=\textwidth,height=0.9\textheight]{./tex2pdf.-e6884bf2dada0f3b/60a2504196ffb0c6844e21ac20c6cb5f3aaa7710.png}
\caption{The IQR reflects channels and arroyos with increasing
interpolation radii. Here, the slope-normalized elevation (IQR) for 1,
2, 3, and 5 m of interpolation diameters are shown.
\label{Fig:dz_IQR_1_2_3_5m}}
\end{figure}

\begin{figure}
\centering
\includegraphics[width=\textwidth,height=0.9\textheight]{./tex2pdf.-e6884bf2dada0f3b/4dc5e5da92d1729f5c5e30d2c21109f51540d703.png}
\caption{RMSE (m) from linear fits (polynomial order = 1) for radii 1,
2, 3, and 5 m are shown. \label{Fig:lasground_RMSE_P1_1_2_3_5m}}
\end{figure}

\begin{figure}
\centering
\includegraphics[width=\textwidth,height=0.9\textheight]{./tex2pdf.-e6884bf2dada0f3b/8ff8be1ca24dd175ebb07139d07126bcf21c4778.png}
\caption{RMSE (m) from second-order fits (polynomial order = 2) for
radii 1, 2, 3, and 5 m are shown.
\label{Fig:lasground_RMSE_P2_1_2_3_5m}}
\end{figure}

\hypertarget{example-02-and-pc-densities}{%
\subsection{Example 02 and PC
densities}\label{example-02-and-pc-densities}}

For a different catchment (stored in the folder Example 02), we have
investigated the impact of PC densities on the outcome. We don't provide
detailed processing steps, but only a short discussion of PC Densities.

In the \emph{map} subdirectory several outputs are generated. First, we
briefly investigate the impact on the DEM subsampling. We compare:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Original Pointcloud with n=574,092 points (DEM and PC density for 1m
  seed spacing: Figure \ref{Fig:org_DEM_PC_density_1m}) Here, the
  following command has been used:

\begin{lstlisting}[language=bash]
python -W ignore \
~/github/PC_geomorph_roughness/\
pc_geomorph_roughness.py 
--inlas Blanca_in_Pozo_USGS_UTM11_NAD83_all_color_cl2_SC12.laz 
--raster_m_range "1 5 1" 
--shapefile_clip ~/github/PC_geomorph_roughness/example_01/SC12.shp 
--epsg_code 26911 --nr_of_cores 0 --create_geotiff 1 --create_gmt 1 
--create_shapefiles 0 --create_las 1 
--create_gmt_maps ~/github/PC_geomorph_roughness/\
example_01/example01_create_map_view_of_PC_geomorph_output_gmt.sh 
--gmt_title "Blanca in Pozo (org PC)" 
--gmt_basename "Pozo_Blanca_cl2" 
2>&1 | tee Blanca_in_Pozo_USGS_UTM11_NAD83_all_color_\
cl2_SC12_pc_geomorph_roughness_1_5_1.log
\end{lstlisting}
\item
  Subsampled PC with k=8 neighborhood points n=283,663 (DEM and PC
  density for 1m seed spacing: Figure \ref{Fig:k8_DEM_PC_density_1m})

\begin{lstlisting}[language=bash]
python -W ignore \
~/Dropbox/soft/github/PC_geomorph_roughness/\
pc_geomorph_roughness.py 
--inlas Blanca_in_Pozo_USGS_UTM11_NAD83_all_color_cl2_SC12.laz 
--raster_m_range "1 5 1" 
--shapefile_clip~/github/PC_geomorph_roughness/example_01/SC12.shp 
--epsg_code 26911 --nr_of_cores 0 --create_geotiff 1 --create_gmt 1 
--create_shapefiles 0 --create_las 1 
--subsample_1m_pc_k 8 
--create_gmt_maps ~/github/PC_geomorph_roughness/example_01/\
example01_create_map_view_of_PC_geomorph_output_gmt.sh 
--gmt_title "Blanca in Pozo (k=8)" 
--gmt_basename "Pozo_Blanca_cl2_k8" 
2>&1 | tee Blanca_in_Pozo_USGS_UTM11_NAD83_all_color_\
cl2_SC12_pc_geomorph_roughness_subsample_k8_1_5_1.log
\end{lstlisting}
\item
  Subsampled PC with probabilities based on densities to a fraction of
  0.5 with n=287,046 (DEM and PC density for 1m seed spacing: Figure
  \ref{Fig:p05_DEM_PC_density_1m})

\begin{lstlisting}[language=bash]
python -W ignore \
~/Dropbox/soft/github/PC_geomorph_roughness/\
pc_geomorph_roughness.py \
--inlas Blanca_in_Pozo_USGS_UTM11_NAD83_all_color_cl2_SC12.laz \
--raster_m_range "1 5 1" \
--shapefile_clip ~/github/PC_geomorph_roughness/example_01/SC12.shp \
--epsg_code 26911 --nr_of_cores 0 --create_geotiff 1 --create_gmt 1  \
--create_shapefiles 0 --create_las 1 \
--subsample_1m_pc_p 0.8 \
--create_gmt_maps \
~/github/PC_geomorph_roughness/example_01/\
example01_create_map_view_of_PC_geomorph_output_gmt.sh \
--gmt_title "Blanca in Pozo (p=0.8)" \
--gmt_basename "Pozo_Blanca_cl2_p08" \
2>&1 | tee Blanca_in_Pozo_USGS_UTM11_NAD83_all_color_\
cl2_SC12_pc_geomorph_roughness_subsample_p08_1_5_1.log
\end{lstlisting}
\item
  Subsampled PC with probabilities based on densities to a fraction of
  0.8 with n=459,273 (DEM and PC density for 1m seed spacing: Figure
  \ref{Fig:p08_DEM_PC_density_1m})

\begin{lstlisting}
python -W ignore \
~/Dropbox/soft/github/PC_geomorph_roughness/\
pc_geomorph_roughness.py \
--inlas Blanca_in_Pozo_USGS_UTM11_NAD83_all_color_cl2_SC12.laz \
--raster_m_range "1 5 1" \
--shapefile_clip \
~/github/PC_geomorph_roughness/example_01/SC12.shp \
--epsg_code 26911 --nr_of_cores 0 --create_geotiff 1 \
--create_gmt 1 --create_shapefiles 0 \
--create_las 1 --subsample_1m_pc_p 0.8 \
--create_gmt_maps \
~/github/PC_geomorph_roughness/example_01/\
example01_create_map_view_of_PC_geomorph_output_gmt.sh \
--gmt_title "Blanca in Pozo (p=0.8)" \
--gmt_basename "Pozo_Blanca_cl2_p08" \
2>&1 | tee Blanca_in_Pozo_USGS_UTM11_NAD83_all_color_\
cl2_SC12_pc_geomorph_roughness_subsample_p08_1_5_1.log
\end{lstlisting}
\end{enumerate}

\begin{figure}
\centering
\includegraphics{./tex2pdf.-e6884bf2dada0f3b/bd1c1ac312900576d6cb8247489a52d91bd2bf21.png}
\caption{DEM and PC density for 1m seed spacing: original point cloud,
no subsampling. Note the large range of point densities (n=574,092).
\label{Fig:org_DEM_PC_density_1m}}
\end{figure}

\begin{figure}
\centering
\includegraphics{./tex2pdf.-e6884bf2dada0f3b/2da20a42061ee58b434f36b93fa8ff9fcc3820fc.png}
\caption{DEM and PC density for 1m seed spacing: subsampled point cloud
with k=8 neighborhood points (n=283,663). Note the greatly reduced
variability in point densities.\label{Fig:k8_DEM_PC_density_1m}}
\end{figure}

\begin{figure}
\centering
\includegraphics{./tex2pdf.-e6884bf2dada0f3b/00f3f8e4bd4593dbdb584d411f22b27b2ae807ac.png}
\caption{DEM and PC density for 1m seed spacing: subsampled point cloud
with probabilities to create a PC with 50\% of the original points
(n=287,046). Point densities are very similar and point cloud has been
homogenized.\label{Fig:p05_DEM_PC_density_1m}}
\end{figure}

\begin{figure}
\centering
\includegraphics{./tex2pdf.-e6884bf2dada0f3b/d7352146bc0009aee49cbeea9508617082833b03.png}
\caption{DEM and PC density for 1m seed spacing: subsampled point cloud
with probabilities to create a PC with 80\% of the original points
(n=459,273). Point densities are still moderately high, but reduced
compared to original point cloud.\label{Fig:p08_DEM_PC_density_1m}}
\end{figure}

A comparison of point densities across several neighborhood sizes
reveals that the discrepancies tend to homogenize (Figure
\ref{Fig:k8_DEM_PC_density_1m_2m_3m_4m}).

\begin{figure}
\centering
\includegraphics{./tex2pdf.-e6884bf2dada0f3b/500d8ab9855c1f770ec1a443106731b29cb99554.png}
\caption{PC density for 1, 2, 3, and 4m seed spacing for k=8 points/m2
subsampling. Note that discrepancies tend to homogenize at larger
grid-cell sizes. There were n=459,273 original
points.\label{Fig:k8_DEM_PC_density_1m_2m_3m_4m}}
\end{figure}

\hypertarget{example-03}{%
\subsection{Example 03}\label{example-03}}

In the example, we just list the steps and provide the setup to run the
LAS file in folder example\_03.

\hypertarget{pre-processing-and-pc-classification}{%
\subsubsection{Pre-processing and PC
classification}\label{pre-processing-and-pc-classification}}

\begin{lstlisting}[language=bash]
cd example_03
pdal translate Pozo_USGS_UTM11_NAD83_cat17.laz Pozo_USGS_UTM11_NAD83_cat17_SMRF_cl2.las --json example03_PDAL_SMRF_pipeline.json
\end{lstlisting}

Here, we experienced some issues with PDAL-SMRF (not all ground points
were classified) and we relied on the lasground classification:

\begin{lstlisting}[language=bash]
wine /opt/LAStools/bin/lasclassify.exe -i Pozo_USGS_UTM11_NAD83_cat17.laz -olaz -set_user_data 0 -set_classification 0 -o Pozo_USGS_UTM11_NAD83_cat17_uncl.laz
wine /opt/LAStools/bin/lasnoise.exe -i Pozo_USGS_UTM11_NAD83_cat17_uncl.laz -step_xy 2 -step_z 1 -isolated 5 -olaz -o Pozo_USGS_UTM11_NAD83_cat17_uncln.laz
wine /opt/LAStools/bin/lasground.exe -i Pozo_USGS_UTM11_NAD83_cat17_uncln.laz -by_flightline -wilderness -extra_fine -offset 0.25 -stddev 20 -step 1 -spike 0.5 -bulge 0.5 -olaz -o Pozo_USGS_UTM11_NAD83_cat17_clg.laz 
wine /opt/LAStools/bin/las2las.exe -i Pozo_USGS_UTM11_NAD83_cat17_clg.laz -keep_class 2 -olaz -o Pozo_USGS_UTM11_NAD83_cat17_clg_cl2.laz 
mkdir dtm_interp
wine /opt/LAStools/bin/blast2dem.exe -keep_class 2 -utm 11N -nad83 -meter -elevation_meter -merged -step 1 -i Pozo_USGS_UTM11_NAD83_cat17_clg_cl2.laz -o dtm_interp/Pozo_USGS_UTM11_NAD83_cat17_clg_cl2_1m.tif
\end{lstlisting}

This original PC is provided in
\href{https://github.com/BodoBookhagen/PC_geomorph_roughness/blob/master/example_03/Pozo_USGS_UTM11_NAD83_cat17.laz}{example\_03/Pozo\_USGS\_UTM11\_NAD83\_cat17.laz}
and the lastools-classified PC
\href{https://github.com/BodoBookhagen/PC_geomorph_roughness/blob/master/example_03/Pozo_USGS_UTM11_NAD83_cat17_clg.laz}{example\_03/Pozo\_USGS\_UTM11\_NAD83\_cat17\_clg.laz}.

\hypertarget{density-based-subsampling-and-gmt-map-generation}{%
\subsubsection{Density-based subsampling and GMT map
generation}\label{density-based-subsampling-and-gmt-map-generation}}

We use the provided GMT script
(example03\_create\_map\_view\_of\_PC\_geomorph\_output\_gmt.sh) to
generate map views from the subsampled PC.

\emph{NOTE: Make sure to give the full path to the Shapefile used as
clip and for the GMT Shell script!}

\begin{lstlisting}[language=bash]
python -W ignore ~/github/PC_geomorph_roughness/\
PC_geomorph_roughness/pc_geomorph_roughness.py \
    -i Pozo_USGS_UTM11_NAD83_cat17_clg_cl2.laz \
    --raster_m_range "1 10 1" \
    --shapefile_clip ~/github/PC_geomorph_roughness/\
example_03/Pozo_DTM_noveg_UTM11_NAD83_cat17.shp \
    --epsg_code 26911 --nr_of_cores 0 --create_geotiff 1 --create_gmt 0  \
    --create_shapefiles 0 --create_las 1 \
    --dem_fname ~/github/PC_geomorph_roughness/\
example_03/dtm_interp/Pozo_USGS_UTM11_NAD83_cat17_clg_cl2_1m.tif \
    --subsample_1m_pc_p 0.8 \
    --create_gmt_maps ~/github/PC_geomorph_roughness/\
example_03/example03_create_map_view_of_PC_geomorph_output_gmt.sh \
    --gmt_title "Ex03 lasground in Pozo" \
    --gmt_basename "Ex03_cl2" \
    2>&1 | tee Pozo_USGS_UTM11_NAD83_cat17_lasground_cl2_pc_geomorph_roughness_subsample_p08_1_10_1.log
\end{lstlisting}

This will generate a set of output maps with GMT that are illustrated
below (Figures \ref{Fig:Ex03_cl2_1.0m_2panel_DEMs},
\ref{Fig:Ex03_cl2_1.0m_2panel_SLPs},
\ref{Fig:Ex03_cl2_1.0m_2panel_RMSE},
\ref{Fig:Ex03_lasground_slopeP2_1_2_3_5m},
\ref{Fig:Ex03_lasground_RMSE_P1_1_2_3_5m},
\ref{Fig:Ex03_lasground_dz_IQR_1_2_3_5m}).

\begin{figure}
\centering
\includegraphics[width=\textwidth,height=0.9\textheight]{./tex2pdf.-e6884bf2dada0f3b/8dc649adf49b8070e41d5c516f97d91ad46e1d62.png}
\caption{Output of 1m DEM generated from the interpolated point cloud
and difference DEM between the mean seed height and the interpolated DEM
for Example03. Note that the interpolated DEM is based on all ground
points, while the mean-seed point DEM used the largely reduced seed
point PC.\label{Fig:Ex03_cl2_1.0m_2panel_DEMs}}
\end{figure}

\begin{figure}
\centering
\includegraphics[width=\textwidth,height=0.9\textheight]{./tex2pdf.-e6884bf2dada0f3b/e72c7ace569dbf20e99632d6ca5a3bc009bf27e3.png}
\caption{Slope measurements for Example
03.\label{Fig:Ex03_cl2_1.0m_2panel_SLPs}}
\end{figure}

\begin{figure}
\centering
\includegraphics[width=\textwidth,height=0.9\textheight]{./tex2pdf.-e6884bf2dada0f3b/22b63c0f48fbe32a4255edf01baf2681da0d3b0d.png}
\caption{RMSE measurements for Example
03.\label{Fig:Ex03_cl2_1.0m_2panel_RMSE}}
\end{figure}

\begin{figure}
\centering
\includegraphics[width=\textwidth,height=0.9\textheight]{./tex2pdf.-e6884bf2dada0f3b/2f37c9cb72f89e46480e86c19e4bfaafd07e8d4a.png}
\caption{Slope comparison for Example 03 from 1 to 5m
diameter.\label{Fig:Ex03_lasground_slopeP2_1_2_3_5m}}
\end{figure}

\begin{figure}
\centering
\includegraphics[width=\textwidth,height=0.9\textheight]{./tex2pdf.-e6884bf2dada0f3b/3cd827a82429100ca144546fd8f9854063bafb9a.png}
\caption{RMSE comparison for Example 03 from 1 to 5m
diameter.\label{Fig:Ex03_lasground_RMSE_P1_1_2_3_5m}}
\end{figure}

\begin{figure}
\centering
\includegraphics[width=\textwidth,height=0.9\textheight]{./tex2pdf.-e6884bf2dada0f3b/e87b46c5fb8a80c890d735b58ab2029c6ca1cafb.png}
\caption{IQR of slope-normalized surface for diameter of 1, 2, 3, and
5m.\label{Fig:Ex03_lasground_dz_IQR_1_2_3_5m}}
\end{figure}

\hypertarget{example-04}{%
\subsection{Example 04}\label{example-04}}

In this last example, we use a larger area covering the Blanca formation
of the Pozo catchment (cf.~\label{Fig:Pozo_DEM_examples_map}). This area
contains almost 3 Million points.

\hypertarget{pre-processing-and-pc-classification-1}{%
\subsubsection{Pre-processing and PC
classification}\label{pre-processing-and-pc-classification-1}}

We rely on ground classification with LASTools:

\begin{lstlisting}[language=bash]
cd example_04
wine /opt/LAStools/bin/lasclassify.exe -i Pozo_WestCanada.laz -olaz -set_user_data 0 -set_classification 0 -o Pozo_WestCanada_uncl.laz
wine /opt/LAStools/bin/lasnoise.exe -i Pozo_WestCanada_uncl.laz -step_xy 2 -step_z 1 -isolated 5 -olaz -o Pozo_WestCanada_uncln.laz
wine /opt/LAStools/bin/lasground.exe -i Pozo_WestCanada_uncln.laz -by_flightline -wilderness -extra_fine -offset 0.25 -stddev 20 -step 1 -spike 0.5 -bulge 0.5 -olaz -o Pozo_WestCanada_clg.laz 
wine /opt/LAStools/bin/las2las.exe -i Pozo_WestCanada_clg.laz -keep_class 2 -olaz -o Pozo_WestCanada_clg_cl2.laz 
mkdir dtm_interp
wine /opt/LAStools/bin/blast2dem.exe -keep_class 2 -utm 11N -nad83 -meter -elevation_meter -merged -step 1 -i Pozo_WestCanada_clg_cl2.laz -o dtm_interp/Pozo_WestCanada_clg_cl2_1m.tif
\end{lstlisting}

This original PC is provided in
\href{https://github.com/BodoBookhagen/PC_geomorph_roughness/blob/master/example_04/Pozo_WestCanada.laz}{example\_04/Pozo\_WestCanada.laz}
and the lastools-classified PC
\href{https://github.com/BodoBookhagen/PC_geomorph_roughness/blob/master/example_04/Pozo_WestCanada_clg.laz}{example\_04/Pozo\_WestCanada\_clg.laz}.

\hypertarget{density-based-subsampling-and-gmt-map-generation-1}{%
\subsubsection{Density-based subsampling and GMT map
generation}\label{density-based-subsampling-and-gmt-map-generation-1}}

We use the provided GMT script
(example04\_create\_map\_view\_of\_PC\_geomorph\_output\_gmt.sh) to
generate map views from the subsampled PC.

\emph{NOTE: Make sure to give the full path to the Shapefile used as
clip and for the GMT Shell script!}

\begin{lstlisting}[language=bash]
python -W ignore ~/github/PC_geomorph_roughness/\
PC_geomorph_roughness/pc_geomorph_roughness.py \
    -i Pozo_WestCanada_clg_cl2.laz \
    --raster_m_range "1 5 1" \
    --shapefile_clip ~/github/PC_geomorph_roughness/\
example_04/WestCanada.shp \
    --epsg_code 26911 --nr_of_cores 0 --create_geotiff 1 --create_gmt 0  \
    --create_shapefiles 0 --create_las 1 \
    --dem_fname ~/github/PC_geomorph_roughness/\
example_04/dtm_interp/Pozo_WestCanada_clg_cl2_1m.tif \
    --subsample_1m_pc_p 0.8 \
    --create_gmt_maps ~/github/PC_geomorph_roughness/\
example_04/example04_create_map_view_of_PC_geomorph_output_gmt.sh \
    --gmt_title "Ex04 lasground in Pozo" \
    --gmt_basename "Ex04_cl2" \
    2>&1 | tee Pozo_USGS_UTM11_NAD83_Pozo_WestCanada_clg_cl2_pc_geomorph_roughness_subsample_p08_1_5_1.log
\end{lstlisting}

This will generate a set of output maps with GMT that are illustrated
below (Figures \ref{Fig:Ex04_cl2_1.0m_2panel_DEMs},
\ref{Fig:Ex04_cl2_1.0m_2panel_SLPs},
\ref{Fig:Ex04_cl2_1.0m_2panel_RMSE},
\ref{Fig:Ex04_cl2_3.0m_2panel_SLPs}, and
\ref{Fig:Ex04_cl2_3.0m_2panel_RMSE}).

\begin{figure}
\centering
\includegraphics[width=\textwidth,height=0.9\textheight]{./tex2pdf.-e6884bf2dada0f3b/22b3bc909f5543a78026154771e6cd6dbec5c2b8.png}
\caption{DEM view of Example 04. Output of 1m DEM generated from the
interpolated point cloud and difference DEM between the mean seed height
and the interpolated DEM. Note that the interpolated DEM is based on all
ground points, while the mean-seed point DEM used the largely reduced
seed-point PC.\label{Fig:Ex04_cl2_1.0m_2panel_DEMs}}
\end{figure}

\begin{figure}
\centering
\includegraphics[width=\textwidth,height=0.9\textheight]{./tex2pdf.-e6884bf2dada0f3b/616bc5d57bc644797e6b07e933a12283c9c2338c.png}
\caption{Slope measurements for Example 04 at 1m diameter
(r=0.5).\label{Fig:Ex04_cl2_1.0m_2panel_SLPs}}
\end{figure}

\begin{figure}
\centering
\includegraphics[width=\textwidth,height=0.9\textheight]{./tex2pdf.-e6884bf2dada0f3b/eb7bf76ff384440df3cf014b2d6e3b703ff28d16.png}
\caption{RMSE measurements for Example 04 at 1m diameter
(r=0.5).\label{Fig:Ex04_cl2_1.0m_2panel_RMSE}}
\end{figure}

\begin{figure}
\centering
\includegraphics[width=\textwidth,height=0.9\textheight]{./tex2pdf.-e6884bf2dada0f3b/19d5cf796134d90581ea2ee890f5e77a95cd84a5.png}
\caption{Slope measurements for Example 04 at 3m diameter
(r=1.5).\label{Fig:Ex04_cl2_3.0m_2panel_SLPs}}
\end{figure}

\begin{figure}
\centering
\includegraphics[width=\textwidth,height=0.9\textheight]{./tex2pdf.-e6884bf2dada0f3b/e3538b59ae9604f2dda37d17f457e1c96f2a1805.png}
\caption{RMSE measurements for Example 04 at 3m diameter
(r=1.5).\label{Fig:Ex04_cl2_3.0m_2panel_RMSE}}
\end{figure}

\end{document}
